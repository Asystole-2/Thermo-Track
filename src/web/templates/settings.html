{% extends "layout.html" %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="header-title">User & System Settings</h1>
                        <p class="header-subtitle">Configure user profile, API keys, and system preferences.</p>
                    </div>
                    <!-- Right side: Notification bell -->
                    {% include 'components/notification_bell.html' %}
                </div>
            </header>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mb-6">
                        {% for category, message in messages %}
                            <div class="flash {{ category }} rounded-lg text-sm" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}


    <!-- System Configuration -->
    <section class="mt-8">
      <h3 class="text-xl font-semibold mb-4 text-gray-300">
        System Configuration
      </h3>
      <div class="card">
        <label
          for="systemName"
          class="block text-sm font-medium text-gray-300 mb-2"
          >System Name</label
        >
        <input
          id="systemName"
          name="systemName"
          type="text"
          class="tt_voiceable form-input"
          placeholder="Say your system name..."
        />
      </div>
    </section>

    <!-- -------------------------------- -->
    <!-- ADMIN-ONLY USER MANAGEMENT PANEL -->
    <!-- -------------------------------- -->

    {% if session.get('role') == 'admin' %}
    <section class="mt-10">
      <h3 class="text-xl font-semibold mb-4 text-gray-200">User Management</h3>

      <div class="card p-6 space-y-6">
        <!-- Add New User -->
        <form
          action="{{ url_for('admin_create_user') }}"
          method="post"
          class="space-y-4"
        >
          <h3 class="text-lg font-semibold text-gray-300">Add New User</h3>

          <input
            type="text"
            name="username"
            class="form-input"
            placeholder="Username"
            required
          />
          <input
            type="email"
            name="email"
            class="form-input"
            placeholder="Email"
            required
          />
          <input
            type="password"
            name="password"
            class="form-input"
            placeholder="Password"
            required
          />

          <label class="form-label">Role</label>
          <select name="role" class="form-input" required>
            <option value="technician">Technician</option>
            <option value="user">User</option>
            <option value="viewer">Viewer</option>
          </select>

          <button class="btn btn-primary w-full">Create User</button>
        </form>

        <!-- Existing Users -->
        <div>
          <h3 class="text-lg font-semibold text-gray-300 mb-3">
            Existing Users
          </h3>

          <table class="table w-full">
            <thead>
              <tr>
                <th class="text-left">Username</th>
                <th class="text-left">Email</th>
                <th class="text-left">Role</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.role }}</td>
                <td class="text-right">
                  {% if u.role != 'admin' %}
                  <form
                    action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                    method="post"
                    class="inline"
                  >
                    <button
                      class="btn btn-danger btn-sm"
                      onclick="return confirm('Delete user {{ u.username }}?')"
                    >
                      Delete
                    </button>
                  </form>
                  {% else %}
                  <span class="text-gray-600 text-sm">protected</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
    {% endif %}
  </main>
</div>
{% endblock %}
