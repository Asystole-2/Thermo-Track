{% extends "layout.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2">
                            User & System Settings
                        </h1>
                        <p class="header-subtitle">
                            Configure user profile and management.
                        </p>
                    </div>
                    {% include 'components/notification_bell.html' %}
                </div>
            </header>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mb-6">
                        {% for category, message in messages %}
                            <div class="flash {{ category }} rounded-lg text-sm" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Tab Navigation -->
            {% if session.get('role') in ['admin', 'technician'] %}
                <div class="mb-6">
                    <div class="border-b border-border">
                        <nav class="-mb-px flex space-x-8">
                            <button
                                    id="profile-tab"
                                    class="tab-button active py-4 px-1 border-b-2 border-accent-blue font-medium text-sm text-accent-blue"
                                    onclick="switchTab('profile')"
                            >
                                <i class="fas fa-user mr-2"></i>My Profile
                            </button>
                            <button
                                    id="users-tab"
                                    class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-text-muted hover:text-text-primary hover:border-border"
                                    onclick="switchTab('users')"
                            >
                                <i class="fas fa-users mr-2"></i>User Management
                            </button>
                        </nav>
                    </div>
                </div>
            {% endif %}

            <!-- Profile Tab Content -->
            <div id="profile-content" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Profile Picture & Basic Info -->
                    <div class="lg:col-span-1">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-text-primary mb-4">
                                Profile Picture
                            </h3>

                            <div class="flex flex-col items-center space-y-4">
                                <div class="relative">
                                    {% if session.get('profile_picture') %}
                                        <img
                                                id="profile-preview"
                                                src="{{ url_for('static', filename='uploads/profiles/' + session.profile_picture) }}?v={{ range(1, 100000) | random }}"
                                                alt="Profile Picture"
                                                class="w-32 h-32 rounded-full object-cover border-4 border-border"
                                                onerror="this.src='{{ url_for('static', filename='images/default-avatar.png') }}'"
                                        />
                                    {% else %}
                                        <img
                                                id="profile-preview"
                                                src="{{ url_for('static', filename='images/default-avatar.png') }}"
                                                alt="Profile Picture"
                                                class="w-32 h-32 rounded-full object-cover border-4 border-border"
                                        />
                                    {% endif %}
                                    <label for="profile-upload"
                                           class="absolute bottom-2 right-2 bg-accent-blue rounded-full p-2 cursor-pointer hover:bg-accent-blue-hover transition-colors">
                                        <i class="fas fa-camera text-white text-sm"></i>
                                    </label>
                                </div>

                                <div class="text-center">
                                    <h2 class="text-xl font-bold text-text-primary">
                                        {{ session.get('username', 'User') }}
                                    </h2>
                                    <p class="text-text-muted text-sm">
                                        {{ session.get('role', 'User')|title }}
                                    </p>
                                    <p class="text-text-muted text-sm mt-2">
                                        Member since {{ session.get('created_at', 'Unknown') }}
                                    </p>
                                </div>

                                <input
                                        type="file"
                                        id="profile-upload"
                                        accept="image/*"
                                        class="hidden"
                                />
                                <button
                                        onclick="document.getElementById('profile-upload').click()"
                                        class="btn btn-secondary w-full"
                                >
                                    <i class="fas fa-upload mr-2"></i>Upload Photo
                                </button>

                                {% if session.get('profile_picture') %}
                                    <button
                                            onclick="showDeleteProfilePictureConfirm()"
                                            class="btn btn-danger w-full"
                                    >
                                        <i class="fas fa-trash mr-2"></i>Remove Photo
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Theme Settings -->
                        <div class="card p-6 mt-6">
                            <h3 class="text-lg font-semibold text-text-primary mb-4">
                                Theme Settings
                            </h3>

                            <div class="space-y-3">
                                <button
                                        onclick="setTheme('light')"
                                        class="theme-option w-full flex items-center justify-between p-3 rounded-lg border border-border hover:bg-tertiary transition-colors"
                                        id="light-theme-btn"
                                >
                                    <div class="flex items-center">
                                        <i class="fas fa-sun text-yellow-500 mr-3"></i>
                                        <span class="text-text-primary">Light Mode</span>
                                    </div>
                                    <i class="fas fa-check text-accent-blue hidden" id="light-check"></i>
                                </button>

                                <button
                                        onclick="setTheme('dark')"
                                        class="theme-option w-full flex items-center justify-between p-3 rounded-lg border border-border hover:bg-tertiary transition-colors"
                                        id="dark-theme-btn"
                                >
                                    <div class="flex items-center">
                                        <i class="fas fa-moon text-blue-400 mr-3"></i>
                                        <span class="text-text-primary">Dark Mode</span>
                                    </div>
                                    <i class="fas fa-check text-accent-blue hidden" id="dark-check"></i>
                                </button>

                                <button
                                        onclick="setTheme('system')"
                                        class="theme-option w-full flex items-center justify-between p-3 rounded-lg border border-border hover:bg-tertiary transition-colors"
                                        id="system-theme-btn"
                                >
                                    <div class="flex items-center">
                                        <i class="fas fa-desktop text-gray-500 mr-3"></i>
                                        <span class="text-text-primary">System Default</span>
                                    </div>
                                    <i class="fas fa-check text-accent-blue hidden" id="system-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Details & Password -->
                    <div class="lg:col-span-2">
                        <!-- Profile Information -->
                        <div class="card p-6 mb-6">
                            <h3 class="text-lg font-semibold text-text-primary mb-4">
                                Profile Information
                            </h3>

                            <form id="profileForm" action="{{ url_for('update_profile') }}" method="post" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="form-label text-text-primary">Username</label>
                                        <input
                                                type="text"
                                                name="username"
                                                value="{{ session.get('username', '') }}"
                                                class="form-input"
                                                required
                                        />
                                    </div>

                                    <div>
                                        <label class="form-label text-text-primary">Email</label>
                                        <input
                                                type="email"
                                                name="email"
                                                value="{{ session.get('email', '') }}"
                                                class="form-input"
                                                required
                                        />
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="form-label text-text-primary">First Name</label>
                                        <input
                                                type="text"
                                                name="first_name"
                                                value="{{ session.get('first_name', '') }}"
                                                class="form-input"
                                                placeholder="Optional"
                                        />
                                    </div>

                                    <div>
                                        <label class="form-label text-text-primary">Last Name</label>
                                        <input
                                                type="text"
                                                name="last_name"
                                                value="{{ session.get('last_name', '') }}"
                                                class="form-input"
                                                placeholder="Optional"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label text-text-primary">Bio</label>
                                    <textarea
                                            name="bio"
                                            rows="3"
                                            class="form-input"
                                            placeholder="Tell us a little about yourself..."
                                    >{{ session.get('bio', '') }}</textarea>
                                </div>

                                <button type="button" onclick="showUpdateProfileConfirm()" class="btn btn-primary">
                                    <i class="fas fa-save mr-2"></i>Update Profile
                                </button>
                            </form>
                        </div>

                        <!-- Change Password -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-text-primary mb-4">
                                Change Password
                            </h3>

                            <form id="passwordForm" action="{{ url_for('change_password') }}" method="post" class="space-y-4">
                                <div>
                                    <label class="form-label text-text-primary">Current Password</label>
                                    <input
                                            type="password"
                                            name="current_password"
                                            class="form-input"
                                            required
                                    />
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="form-label text-text-primary">New Password</label>
                                        <input
                                                type="password"
                                                name="new_password"
                                                class="form-input"
                                                required
                                        />
                                    </div>

                                    <div>
                                        <label class="form-label text-text-primary">Confirm New Password</label>
                                        <input
                                                type="password"
                                                name="confirm_password"
                                                class="form-input"
                                                required
                                        />
                                    </div>
                                </div>

                                <div class="bg-blue-900 bg-opacity-20 border border-blue-500 rounded-lg p-3">
                                    <p class="text-blue-300 text-sm">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Password must be at least 8 characters with uppercase, number, and symbol.
                                    </p>
                                </div>

                                <button type="button" onclick="showChangePasswordConfirm()" class="btn btn-primary">
                                    <i class="fas fa-key mr-2"></i>Change Password
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab Content (Admin/Technician only) -->
            {% if session.get('role') in ['admin', 'technician'] %}
                <div id="users-content" class="tab-content hidden">
                    <div class="card p-6 space-y-6">
                        <!-- Add New User -->
                        <form
                                action="{{ url_for('admin_create_user') }}"
                                method="post"
                                class="space-y-4"
                        >
                            <h3 class="text-lg font-semibold text-text-primary">Add New User</h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input
                                        type="text"
                                        name="username"
                                        class="form-input"
                                        placeholder="Username"
                                        required
                                />
                                <input
                                        type="email"
                                        name="email"
                                        class="form-input"
                                        placeholder="Email"
                                        required
                                />
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input
                                        type="password"
                                        name="password"
                                        class="form-input"
                                        placeholder="Password"
                                        required
                                />

                                <select name="role" class="form-input" required>
                                    <option value="">Select Role</option>
                                    {% if session.get('role') == 'admin' %}
                                        <option value="admin">Admin</option>
                                    {% endif %}
                                    <option value="technician">Technician</option>
                                    <option value="user">User</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>

                            <button class="btn btn-primary">
                                <i class="fas fa-user-plus mr-2"></i>Create User
                            </button>
                        </form>

                        <!-- Existing Users -->
                        <div>
                            <h3 class="text-lg font-semibold text-text-primary mb-4">
                                Existing Users
                            </h3>

                            <div class="overflow-x-auto">
                                <table class="table w-full">
                                    <thead>
                                    <tr class="border-b border-border">
                                        <th class="text-left py-3 text-text-primary font-semibold">User</th>
                                        <th class="text-left py-3 text-text-primary font-semibold">Email</th>
                                        <th class="text-left py-3 text-text-primary font-semibold">Role</th>
                                        {% if session.get('role') in ['admin', 'technician'] %}
                                            <th class="text-left py-3 text-text-primary font-semibold">Alter Role</th>
                                        {% endif %}
                                        <th class="text-right py-3 text-text-primary font-semibold">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for u in users %}
                                        {% if session.get('role') != 'technician' or u.role != 'technician' %}
                                            <tr class="border-b border-border hover:bg-tertiary transition-colors">
                                                <td class="py-3">
                                                    <div class="flex items-center gap-3">
                                                        <!-- Profile Image -->
                                                        <div class="relative">
                                                            {% if u.profile_picture %}
                                                                <img
                                                                        src="{{ url_for('static', filename='uploads/profiles/' + u.profile_picture) }}?v={{ range(1, 100000) | random }}"
                                                                        alt="{{ u.username }}"
                                                                        class="w-8 h-8 rounded-full object-cover border-2 border-border"
                                                                        onerror="this.src='{{ url_for('static', filename='images/default-avatar.png') }}'"
                                                                />
                                                            {% else %}
                                                                <!-- Default profile icon based on role -->
                                                                <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-border
                              {% if u.role == 'admin' %}bg-purple-100 text-purple-600
                              {% elif u.role == 'technician' %}bg-blue-100 text-blue-600
                              {% elif u.role == 'user' %}bg-green-100 text-green-600
                              {% else %}bg-gray-100 text-gray-600{% endif %}">
                                                                    <i class="fas
                                {% if u.role == 'admin' %}fa-crown text-xs
                                {% elif u.role == 'technician' %}fa-tools text-xs
                                {% elif u.role == 'user' %}fa-user text-xs
                                {% else %}fa-eye text-xs{% endif %}"></i>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        <div>
                                                            <div class="text-text-primary font-medium">{{ u.username }}</div>
                                                            {% if u.first_name or u.last_name %}
                                                                <div class="text-text-muted text-xs">
                                                                    {{ u.first_name or '' }} {{ u.last_name or '' }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="py-3 text-text-secondary">{{ u.email }}</td>
                                                <td class="py-3">
                      <span class="px-2 py-1 rounded text-xs font-medium
                        {% if u.role == 'admin' %}bg-purple-600 text-white
                        {% elif u.role == 'technician' %}bg-blue-600 text-white
                        {% elif u.role == 'user' %}bg-green-600 text-white
                        {% else %}bg-gray-600 text-white{% endif %}">
                        <i class="fas
                          {% if u.role == 'admin' %}fa-crown mr-1
                          {% elif u.role == 'technician' %}fa-tools mr-1
                          {% elif u.role == 'user' %}fa-user mr-1
                          {% else %}fa-eye mr-1{% endif %}"></i>
                        {{ u.role }}
                      </span>
                                                </td>

                                                {% if session.get('role') in ['admin', 'technician'] %}
                                                    <td class="py-3">
                                                        <form action="{{ url_for('update_user_role', user_id=u.id) }}"
                                                              method="post" class="inline" id="role-form-{{ u.id }}">
                                                            <select name="role" class="form-input text-sm py-1"
                                                                    onchange="confirmRoleChange('{{ u.username }}', '{{ u.role }}', this.value, '{{ u.id }}')">
                                                                {% if session.get('role') == 'admin' %}
                                                                    <option value="admin"
                                                                            {% if u.role=='admin' %}selected{% endif %}>
                                                                        <i class="fas fa-crown mr-2"></i>Admin
                                                                    </option>
                                                                    <option value="technician"
                                                                            {% if u.role=='technician' %}selected{% endif %}>
                                                                        <i class="fas fa-tools mr-2"></i>Technician
                                                                    </option>
                                                                {% endif %}
                                                                <option value="user"
                                                                        {% if u.role=='user' %}selected{% endif %}>
                                                                    <i class="fas fa-user mr-2"></i>User
                                                                </option>
                                                                <option value="viewer"
                                                                        {% if u.role=='viewer' %}selected{% endif %}>
                                                                    <i class="fas fa-eye mr-2"></i>Viewer
                                                                </option>
                                                            </select>
                                                        </form>
                                                    </td>
                                                {% endif %}

                                                <td class="py-3 text-right">
                                                    <div class="flex justify-end gap-2">
                                                        <!-- View Profile Button -->
                                                        <button
                                                                class="btn btn-secondary btn-sm flex items-center gap-1"
                                                                onclick="viewUserProfile({{ u.id }})"
                                                                title="View Profile"
                                                        >
                                                            <i class="fas fa-eye"></i>
                                                        </button>

                                                        {% if u.role != 'admin' %}
                                                            <!-- Technician is allowed to delete non-technician, non-admin users -->
                                                            {% if u.role != 'technician' or session.get('role') == 'admin' %}
                                                                <button
                                                                        class="btn btn-danger btn-sm flex items-center gap-1"
                                                                        onclick="showDeleteUserConfirm('{{ u.username }}', {{ u.id }})"
                                                                        title="Delete User"
                                                                >
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            {% else %}
                                                                <span class="text-text-muted text-sm">protected</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-text-muted text-sm">protected</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-secondary rounded-xl shadow-xl w-full max-w-md max-h-[90vh] sm:max-h-[85vh] overflow-hidden border border-border mx-2 sm:mx-0">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 sm:p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-text-primary flex items-center gap-2">
                    <i class="fas fa-user-circle text-accent-blue"></i>
                    <span class="text-sm sm:text-base">User Profile</span>
                </h3>
                <button id="closeUserProfileModal" class="text-text-muted hover:text-text-primary text-xl transition-colors">
                    &times;
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-3 sm:p-4 md:p-6 overflow-y-auto max-h-[calc(90vh-140px)] sm:max-h-[calc(85vh-140px)]">
                <div id="userProfileContent">
                    <!-- Loading will be inserted here temporarily -->

                    <!-- Main Content (initially hidden) -->
                    <div id="modalMainContent" class="space-y-4 sm:space-y-6">
                        <!-- Profile Header -->
                        <div class="text-center">
                            <!-- Profile Image/Icon -->
                            <div class="relative mx-auto mb-3 sm:mb-4">
                                <img id="modalProfileImage"
                                     src=""
                                     alt="Profile Picture"
                                     class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 rounded-full object-cover border-4 border-border mx-auto hidden">
                                <div id="modalProfileIcon"
                                     class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 rounded-full flex items-center justify-center border-4 border-border mx-auto text-xl sm:text-2xl hidden">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>

                            <!-- Username and Role -->
                            <h2 id="modalUsername" class="text-lg sm:text-xl font-bold text-text-primary mb-1 truncate px-2"></h2>
                            <div id="modalUserRole" class="inline-flex items-center gap-1 px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium mb-2">
                                <i class="fas fa-user text-xs"></i>
                                <span class="truncate">User</span>
                            </div>
                            <p id="modalUserEmail" class="text-text-muted text-xs sm:text-sm truncate px-2"></p>
                        </div>

                        <!-- Personal Information -->
                        <div class="bg-tertiary rounded-lg p-3 sm:p-4">
                            <h4 class="text-sm sm:text-md font-semibold text-text-primary mb-2 sm:mb-3">Personal Information</h4>
                            <div class="space-y-2 text-xs sm:text-sm">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1">
                                    <span class="text-text-muted font-medium">Full Name:</span>
                                    <span id="modalFullName" class="text-text-primary text-right truncate">—</span>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1">
                                    <span class="text-text-muted font-medium">Member Since:</span>
                                    <span id="modalMemberSince" class="text-text-primary text-right">—</span>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="bg-tertiary rounded-lg p-3 sm:p-4">
                            <h4 class="text-sm sm:text-md font-semibold text-text-primary mb-2 sm:mb-3">Statistics</h4>
                            <div class="grid grid-cols-2 gap-3 sm:gap-4">
                                <div class="bg-secondary rounded-lg p-2 sm:p-3 text-center">
                                    <div id="modalOwnedRooms" class="text-lg sm:text-xl md:text-2xl font-bold text-accent-blue">0</div>
                                    <div class="text-text-muted text-xs">Owned Rooms</div>
                                </div>
                                <div class="bg-secondary rounded-lg p-2 sm:p-3 text-center">
                                    <div id="modalActiveRequests" class="text-lg sm:text-xl md:text-2xl font-bold text-accent-blue">0</div>
                                    <div class="text-text-muted text-xs">Active Requests</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bio -->
                        <div class="bg-tertiary rounded-lg p-3 sm:p-4">
                            <h4 class="text-sm sm:text-md font-semibold text-text-primary mb-2">Bio</h4>
                            <p id="modalUserBio" class="text-text-primary text-xs sm:text-sm bg-secondary rounded-lg p-2 sm:p-3 min-h-[50px] sm:min-h-[60px] max-h-[100px] overflow-y-auto">
                                No bio provided
                            </p>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-tertiary rounded-lg p-3 sm:p-4">
                            <h4 class="text-sm sm:text-md font-semibold text-text-primary mb-2 sm:mb-3">Recent Activity</h4>
                            <div id="modalRecentActivity" class="space-y-2 text-xs sm:text-sm">
                                <div class="text-text-muted italic text-center py-2">No recent activity</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end p-3 sm:p-4 md:p-6 border-t border-border">
                <!-- Close button removed as per original -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-secondary rounded-xl shadow-xl w-full max-w-md max-h-[90vh] sm:max-h-[85vh] overflow-hidden border border-border mx-2 sm:mx-0">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 sm:p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-text-primary flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    <span class="text-sm sm:text-base" id="confirmModalTitle">Confirm Action</span>
                </h3>
                <button id="closeConfirmModal" class="text-text-muted hover:text-text-primary text-xl transition-colors">
                    &times;
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-4 sm:p-6 overflow-y-auto">
                <p class="text-text-primary mb-4 text-sm sm:text-base" id="confirmModalMessage">
                    Are you sure you want to perform this action?
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-end">
                    <button id="cancelConfirm"
                            class="btn bg-tertiary hover:bg-tertiary-hover text-text-primary px-4 py-2 text-sm sm:text-base order-2 sm:order-1 w-full sm:w-auto">
                        Cancel
                    </button>
                    <button id="proceedConfirm"
                            class="btn px-4 py-2 text-sm sm:text-base order-1 sm:order-2 w-full sm:w-auto"
                            data-action=""
                            data-form-id="">
                        Proceed
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-button.active {
            border-bottom-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .theme-option {
            transition: all 0.2s ease-in-out;
            background-color: var(--bg-primary);
        }

        .theme-option:hover {
            transform: translateY(-1px);
            background-color: var(--bg-tertiary);
        }

        .theme-option.active {
            background-color: var(--accent-blue);
            background-opacity: 0.2;
            border-color: var(--accent-blue);
        }

        /* Confirmation Modal Styles */
        #confirmModal {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        #confirmModal > div {
            animation: modalSlideIn 0.3s ease-out;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>

    <script>
        // Confirmation Modal State
        window.confirmState = {
            pendingAction: null,
            isModalOpen: false
        };

        // Show confirmation modal for deleting user
        function showDeleteUserConfirm(username, userId) {
            window.confirmState.pendingAction = 'delete-user';
            window.confirmState.userId = userId;

            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmModalTitle');
            const message = document.getElementById('confirmModalMessage');
            const proceedBtn = document.getElementById('proceedConfirm');

            title.textContent = 'Delete User';
            message.textContent = `Are you sure you want to delete user "${username}"? This action cannot be undone. All user data including rooms and preferences will be permanently removed.`;

            proceedBtn.textContent = 'Delete User';
            proceedBtn.className = 'btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 text-sm sm:text-base order-1 sm:order-2 w-full sm:w-auto';
            proceedBtn.dataset.action = 'delete-user';
            proceedBtn.dataset.userId = userId;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        // Show confirmation modal for updating profile
        function showUpdateProfileConfirm() {
            window.confirmState.pendingAction = 'update-profile';

            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmModalTitle');
            const message = document.getElementById('confirmModalMessage');
            const proceedBtn = document.getElementById('proceedConfirm');

            title.textContent = 'Update Profile';
            message.textContent = 'Are you sure you want to update your profile information? These changes will be applied immediately.';

            proceedBtn.textContent = 'Update Profile';
            proceedBtn.className = 'btn bg-accent-blue hover:bg-accent-blue-hover text-white px-4 py-2 text-sm sm:text-base order-1 sm:order-2 w-full sm:w-auto';
            proceedBtn.dataset.action = 'update-profile';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        // Show confirmation modal for changing password
        function showChangePasswordConfirm() {
            window.confirmState.pendingAction = 'change-password';

            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmModalTitle');
            const message = document.getElementById('confirmModalMessage');
            const proceedBtn = document.getElementById('proceedConfirm');

            title.textContent = 'Change Password';
            message.textContent = 'Are you sure you want to change your password? You will need to use your new password for all future logins.';

            proceedBtn.textContent = 'Change Password';
            proceedBtn.className = 'btn bg-accent-blue hover:bg-accent-blue-hover text-white px-4 py-2 text-sm sm:text-base order-1 sm:order-2 w-full sm:w-auto';
            proceedBtn.dataset.action = 'change-password';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        // Show confirmation modal for deleting profile picture
        function showDeleteProfilePictureConfirm() {
            window.confirmState.pendingAction = 'delete-profile-picture';

            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmModalTitle');
            const message = document.getElementById('confirmModalMessage');
            const proceedBtn = document.getElementById('proceedConfirm');

            title.textContent = 'Remove Profile Picture';
            message.textContent = 'Are you sure you want to remove your profile picture? This action cannot be undone.';

            proceedBtn.textContent = 'Remove Picture';
            proceedBtn.className = 'btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 text-sm sm:text-base order-1 sm:order-2 w-full sm:w-auto';
            proceedBtn.dataset.action = 'delete-profile-picture';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        // Hide confirmation modal
        function hideConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            document.body.style.overflow = '';
            window.confirmState.pendingAction = null;
            window.confirmState.userId = null;
        }

        // Perform the confirmed action
        function performConfirmedAction() {
            const action = document.getElementById('proceedConfirm').dataset.action;
            const userId = document.getElementById('proceedConfirm').dataset.userId;

            switch (action) {
                case 'delete-user':
                    deleteUser(userId);
                    break;
                case 'update-profile':
                    document.getElementById('profileForm').submit();
                    break;
                case 'change-password':
                    document.getElementById('passwordForm').submit();
                    break;
                case 'delete-profile-picture':
                    removeProfilePicture();
                    break;
            }

            hideConfirmModal();
        }

        // Delete user function
        function deleteUser(userId) {
            fetch(`/admin/users/${userId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('User deleted successfully', 'success');
                    // Reload the page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('Failed to delete user');
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                showToast('Failed to delete user', 'error');
            });
        }

        // Initialize confirmation modal
        function initConfirmModal() {
            const closeModal = document.getElementById('closeConfirmModal');
            const cancelBtn = document.getElementById('cancelConfirm');
            const proceedBtn = document.getElementById('proceedConfirm');

            if (closeModal) closeModal.addEventListener('click', hideConfirmModal);
            if (cancelBtn) cancelBtn.addEventListener('click', hideConfirmModal);
            if (proceedBtn) proceedBtn.addEventListener('click', performConfirmedAction);

            // ESC key support
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const confirmModal = document.getElementById('confirmModal');
                    if (confirmModal && !confirmModal.classList.contains('hidden')) {
                        hideConfirmModal();
                    }
                }
            });

            // Click outside to close
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) {
                confirmModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        hideConfirmModal();
                    }
                });
            }
        }

        // Rest of your existing JavaScript functions remain the same...
        // Debug function to check if modal elements exist
        function debugModalElements() {
            const elements = [
                'modalUsername', 'modalUserEmail', 'modalUserRole', 'modalFullName',
                'modalMemberSince', 'modalOwnedRooms', 'modalActiveRequests',
                'modalUserBio', 'modalRecentActivity', 'modalProfileImage', 'modalProfileIcon',
                'userProfileModal', 'userProfileContent'
            ];

            console.log('=== Debugging Modal Elements ===');
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? 'FOUND' : 'NOT FOUND');
                if (element) {
                    console.log(`  - Tag: ${element.tagName}, Classes: ${element.className}`);
                }
            });
            console.log('=== End Debug ===');
        }

        // User Profile Modal Functions
        function viewUserProfile(userId) {
            console.log('Loading profile for user ID:', userId);

            // Show modal first
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                console.error('User profile modal not found');
                showToast('Error: Modal not found', 'error');
                return;
            }

            // Get the content container
            const userProfileContent = document.getElementById('userProfileContent');
            if (!userProfileContent) {
                console.error('userProfileContent element not found');
                showToast('Error: Modal content not found', 'error');
                return;
            }

            // Store the original HTML structure
            const originalHTML = userProfileContent.innerHTML;

            // Show loading state WITHOUT replacing the entire structure
            const loadingHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-accent-blue mb-2"></i>
            <p class="text-text-muted">Loading user profile...</p>
        </div>
    `;

            // Create a temporary loading container
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = loadingHTML;

            // Hide the main content, show loading
            const mainContent = userProfileContent.querySelector('#modalMainContent');
            if (mainContent) {
                mainContent.classList.add('hidden');
            }
            userProfileContent.appendChild(tempContainer);

            // Fetch user data
            fetch(`/api/user/${userId}/profile`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('User not found');
                    }
                    return response.json();
                })
                .then(userData => {
                    console.log('User data loaded:', userData);
                    // Remove loading element
                    tempContainer.remove();
                    // Show main content again
                    if (mainContent) {
                        mainContent.classList.remove('hidden');
                    }
                    populateUserProfileModal(userData);
                })
                .catch(error => {
                    console.error('Error loading user profile:', error);
                    // Remove loading element and show error
                    tempContainer.remove();
                    if (mainContent) {
                        mainContent.classList.remove('hidden');
                    }
                    showToast(`Error loading user profile: ${error.message}`, 'error');
                });
        }

        function populateUserProfileModal(userData) {
            console.log('Populating modal with data:', userData);

            const {
                username,
                email,
                role,
                profile_picture,
                first_name,
                last_name,
                bio,
                created_at,
                owned_rooms_count = 0,
                active_requests_count = 0,
                recent_activity = []
            } = userData;

            // Safe element setting function
            function safeSetElement(id, value, defaultValue = '—') {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value !== null && value !== undefined ? value : defaultValue;
                    console.log(`Set ${id} to:`, value);
                } else {
                    console.warn(`Element with id '${id}' not found`);
                }
            }

            function safeSetInnerHTML(id, html) {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = html;
                    console.log(`Set ${id} HTML to:`, html);
                } else {
                    console.warn(`Element with id '${id}' not found`);
                }
            }

            // Set basic info
            safeSetElement('modalUsername', username);
            safeSetElement('modalUserEmail', email);

            // Set role badge
            const roleColors = {
                'admin': 'bg-purple-600 text-white',
                'technician': 'bg-blue-600 text-white',
                'user': 'bg-green-600 text-white',
                'viewer': 'bg-gray-600 text-white'
            };

            const roleIcons = {
                'admin': 'fa-crown',
                'technician': 'fa-tools',
                'user': 'fa-user',
                'viewer': 'fa-eye'
            };

            const roleClass = roleColors[role] || roleColors.viewer;
            const roleIcon = roleIcons[role] || roleIcons.viewer;

            safeSetInnerHTML('modalUserRole',
                `<i class="fas ${roleIcon}"></i><span>${role}</span>`
            );

            const roleBadge = document.getElementById('modalUserRole');
            if (roleBadge) {
                roleBadge.className = `inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium mb-2 ${roleClass}`;
            }

            // Set profile image
            const profileImage = document.getElementById('modalProfileImage');
            const profileIcon = document.getElementById('modalProfileIcon');

            if (profileImage && profileIcon) {
                if (profile_picture) {
                    profileImage.src = `/static/uploads/profiles/${profile_picture}?v=${new Date().getTime()}`;
                    profileImage.classList.remove('hidden');
                    profileIcon.classList.add('hidden');
                    console.log('Setting profile image to:', profile_picture);

                    // Add error handling for broken images
                    profileImage.onerror = function () {
                        console.log('Profile image failed to load, falling back to icon');
                        profileImage.classList.add('hidden');
                        profileIcon.classList.remove('hidden');
                        setProfileIconStyle(profileIcon, role);
                    };
                } else {
                    console.log('No profile picture, using icon');
                    profileImage.classList.add('hidden');
                    profileIcon.classList.remove('hidden');
                    setProfileIconStyle(profileIcon, role);
                }
            }

            // Set personal information
            safeSetElement('modalFullName',
                (first_name || last_name) ? `${first_name || ''} ${last_name || ''}`.trim() : '—'
            );

            safeSetElement('modalMemberSince',
                created_at ? new Date(created_at).toLocaleDateString() : '—'
            );

            // Set statistics
            safeSetElement('modalOwnedRooms', owned_rooms_count, '0');
            safeSetElement('modalActiveRequests', active_requests_count, '0');

            // Set bio
            const bioElement = document.getElementById('modalUserBio');
            if (bioElement) {
                if (bio && bio.trim() !== '') {
                    bioElement.textContent = bio;
                    bioElement.className = 'text-text-primary text-sm';
                    console.log('Set bio to:', bio);
                } else {
                    bioElement.innerHTML = '<span class="text-text-muted italic">No bio provided</span>';
                    console.log('No bio provided');
                }
            }

            // Set recent activity
            const activityElement = document.getElementById('modalRecentActivity');
            if (activityElement) {
                if (recent_activity && recent_activity.length > 0) {
                    activityElement.innerHTML = recent_activity.map(activity => `
        <div class="flex items-center justify-between py-1">
          <span class="text-text-primary">${activity.action}</span>
          <span class="text-text-muted text-xs">${activity.time}</span>
        </div>
      `).join('');
                    console.log('Set recent activity with', recent_activity.length, 'items');
                } else {
                    activityElement.innerHTML = '<div class="text-text-muted italic">No recent activity</div>';
                    console.log('No recent activity');
                }
            }
        }

        function setProfileIconStyle(iconElement, role) {
            const roleStyles = {
                admin: 'bg-purple-100 text-purple-600',
                technician: 'bg-blue-100 text-blue-600',
                user: 'bg-green-100 text-green-600',
                viewer: 'bg-gray-100 text-gray-600'
            };

            const roleIcons = {
                admin: 'fa-crown',
                technician: 'fa-tools',
                user: 'fa-user',
                viewer: 'fa-eye'
            };

            const style = roleStyles[role] || roleStyles.viewer;
            const icon = roleIcons[role] || roleIcons.viewer;

            iconElement.className = `w-24 h-24 rounded-full flex items-center justify-center border-4 border-border mx-auto text-2xl ${style}`;
            iconElement.innerHTML = `<i class="fas ${icon}"></i>`;
        }

        function editUserProfile() {
            const userId = document.getElementById('userProfileModal')?.dataset.userId;
            if (userId) {
                // Redirect to user edit page or open edit modal
                alert(`Edit user ${userId} - This would open an edit form in a real implementation`);
            }
        }

        // Modal event listeners
        function initUserProfileModal() {
            const modal = document.getElementById('userProfileModal');
            const closeBtn = document.getElementById('closeUserProfileModal');
            const closeUserProfileBtn = document.getElementById('closeUserProfileBtn');

            if (!modal) {
                console.error('User profile modal not found');
                return;
            }

            function closeModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (closeUserProfileBtn) closeUserProfileBtn.addEventListener('click', closeModal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600' :
                    type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Simple Theme Functions (No dependency on ThemeManager)
        function setTheme(theme) {
            console.log('Setting theme to:', theme);

            // Apply theme directly
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            // Update UI
            updateThemeButtons(theme);
            updateSidebarIcons(theme);

            // Show success message
            showToast(`Theme changed to ${theme} mode`, 'success');

            // If ThemeManager exists, sync with it
            if (window.ThemeManager && typeof window.ThemeManager.applyTheme === 'function') {
                window.ThemeManager.applyTheme(theme);
            }
        }

        function updateThemeButtons(theme) {
            console.log('Updating theme buttons for:', theme);

            // Remove active styles from all buttons
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('bg-accent-blue', 'bg-opacity-20', 'border-accent-blue');
            });

            // Hide all checkmarks
            document.querySelectorAll('.theme-option .fa-check').forEach(check => {
                check.classList.add('hidden');
            });

            // Add active styles to selected theme
            const selectedButton = document.getElementById(`${theme}-theme-btn`);
            const selectedCheck = document.getElementById(`${theme}-check`);

            if (selectedButton && selectedCheck) {
                selectedButton.classList.add('bg-accent-blue', 'bg-opacity-20', 'border-accent-blue');
                selectedCheck.classList.remove('hidden');
                console.log('Updated button for theme:', theme);
            }
        }

        function updateSidebarIcons(theme) {
            const sidebarSunIcon = document.getElementById('sidebar-sun-icon');
            const sidebarMoonIcon = document.getElementById('sidebar-moon-icon');

            if (sidebarSunIcon && sidebarMoonIcon) {
                const isDark = theme === 'dark';
                sidebarSunIcon.classList.toggle('hidden', !isDark);
                sidebarMoonIcon.classList.toggle('hidden', isDark);
            }
        }

        function getCurrentTheme() {
            // Get theme from localStorage, or default to system
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                return storedTheme;
            }

            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }

            return 'light';
        }

        // Tab Functions
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-accent-blue', 'text-accent-blue');
                button.classList.add('border-transparent', 'text-text-muted');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`${tabName}-content`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.classList.remove('hidden');
                console.log('Showing tab content:', tabName);
            }

            // Activate selected tab button
            const selectedButton = document.getElementById(`${tabName}-tab`);
            if (selectedButton) {
                selectedButton.classList.add('active', 'border-accent-blue', 'text-accent-blue');
                selectedButton.classList.remove('border-transparent', 'text-text-muted');
            }
        }

        // Role Change Confirmation
        function confirmRoleChange(username, currentRole, newRole, userId) {
            if (currentRole === newRole) {
                return; // No change needed
            }

            const action = newRole === 'admin' ? 'promote' :
                currentRole === 'admin' ? 'demote' :
                    newRole > currentRole ? 'promote' : 'demote';

            const message = `Are you sure you want to ${action} ${username} from ${currentRole} to ${newRole}?`;

            if (confirm(message)) {
                document.getElementById(`role-form-${userId}`).submit();
            } else {
                // Reset the select to original value
                const select = document.querySelector(`#role-form-${userId} select`);
                select.value = currentRole;
            }
        }

        // Profile Picture Functions
        document.getElementById('profile-upload')?.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profile-preview').src = e.target.result;
                    uploadProfilePicture(file);
                };
                reader.readAsDataURL(file);
            }
        });

        function uploadProfilePicture(file) {
            const formData = new FormData();
            formData.append('profile_picture', file);

            fetch('/api/upload-profile-picture', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Profile picture updated successfully!', 'success');
                        if (data.url) {
                            document.getElementById('profile-preview').src = data.url + '?v=' + new Date().getTime();
                        }
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast('Failed to upload profile picture: ' + data.error, 'error');
                        document.getElementById('profile-preview').src = '{{ url_for("static", filename="images/default-avatar.png") }}';
                    }
                })
                .catch(error => {
                    console.error('Error uploading profile picture:', error);
                    showToast('Error uploading profile picture.', 'error');
                    document.getElementById('profile-preview').src = '{{ url_for("static", filename="images/default-avatar.png") }}';
                });
        }

        function removeProfilePicture() {
            fetch('/api/remove-profile-picture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Profile picture removed successfully!', 'success');
                        document.getElementById('profile-preview').src = '{{ url_for("static", filename="images/default-avatar.png") }}';
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast('Failed to remove profile picture.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error removing profile picture:', error);
                    showToast('Error removing profile picture.', 'error');
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Settings page loaded');

            // Initialize theme buttons
            const currentTheme = getCurrentTheme();
            console.log('Current theme:', currentTheme);
            updateThemeButtons(currentTheme);

            // Initialize user profile modal
            initUserProfileModal();

            // Initialize confirmation modal
            initConfirmModal();

            // Set initial tab based on user role
            const userRole = '{{ session.get("role", "user") }}';
            console.log('User role:', userRole);

            if (userRole === 'user') {
                switchTab('profile');
            }
        });

        // Listen for theme changes from sidebar
        window.addEventListener('themeChange', function (event) {
            console.log('Theme change detected:', event.detail.theme);
            updateThemeButtons(event.detail.theme);
        });
    </script>
{% endblock %}