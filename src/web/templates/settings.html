{% extends "layout.html" %} {% block body %}
<div class="app-container">
  {% include 'components/menu.html' %}

  <main class="main-content">
    <header class="page-header">
      <div class="header-content">
        <div>
          <h1 class="text-4xl font-extrabold text-text-primary mb-2">
            User & System Settings
          </h1>
          <p class="header-subtitle">
            Configure user profile and management.
          </p>
        </div>
        <!-- Right side: Notification bell -->
        {% include 'components/notification_bell.html' %}
      </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="mb-6">
      {% for category, message in messages %}
      <div class="flash {{ category }} rounded-lg text-sm" role="alert">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}
 <a href="/change-password" class="text-blue-500 hover:underline">Change Password</a>
    <!-- -------------------------------- -->
    <!-- ADMIN/TECHNICIAN USER MANAGEMENT PANEL -->
    <!-- -------------------------------- -->

    {% if session.get('role') in ['admin', 'technician'] %}
    <section class="mt-10">
      <h3 class="text-xl font-semibold mb-4 text-gray-300">User Management</h3>

      <div class="card p-6 space-y-6">
        <!-- Add New User (Available for Technicians and Admins) -->
        {% if session.get('role') in ['admin', 'technician'] %}
        <form
          action="{{ url_for('admin_create_user') }}"
          method="post"
          class="space-y-4"
        >
          <h3 class="text-lg font-semibold text-gray-300">Add New User</h3>

          <input
            type="text"
            name="username"
            class="form-input"
            placeholder="Username"
            required
          />
          <input
            type="email"
            name="email"
            class="form-input"
            placeholder="Email"
            required
          />
          <input
            type="password"
            name="password"
            class="form-input"
            placeholder="Password"
            required
          />

          <label class="form-label">Role</label>
          <select name="role" class="form-input" required>
            <option value="technician">Technician</option>
            <option value="user">User</option>
            <option value="viewer">Viewer</option>
          </select>

          <button class="btn btn-primary w-full">Create User</button>
        </form>
        {% endif %}

 <!-- Existing Users (Viewable for Technicians and Admins) -->
<div>
    <h3 class="text-lg font-semibold text-gray-300 mb-3">
        Existing Users
    </h3>

    <table class="table w-full">
        <thead>
            <tr>
                <th class="text-left">Username</th>
                <th class="text-left">Email</th>
                <th class="text-left">Current Role</th>
                {% if session.get('role') == 'technician' %}
                <th class="text-left">Alter Role</th>
                {% endif %}
                <th class="text-right">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            {% if session.get('role') != 'technician' or u.role != 'technician' %}
            <tr>
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>
                    <span class="px-2 py-1 rounded text-xs font-medium
                        {% if u.role == 'admin' %}bg-purple-600 text-white
                        {% elif u.role == 'technician' %}bg-blue-600 text-white
                        {% elif u.role == 'user' %}bg-green-600 text-white
                        {% else %}bg-gray-600 text-white{% endif %}">
                        {{ u.role }}
                    </span>
                </td>

                {% if session.get('role') == 'technician' %}
                <td>
                    <form action="{{ url_for('update_user_role', user_id=u.id) }}" method="post" class="inline">
                        <select name="role" class="form-input text-sm py-1" onchange="this.form.submit()">
                            <option value="admin" {% if u.role=='admin' %}selected{% endif %}>Admin</option>
                            <option value="technician" {% if u.role=='technician' %}selected{% endif %}>Technician</option>
                            <option value="user" {% if u.role=='user' %}selected{% endif %}>User</option>
                            <option value="viewer" {% if u.role=='viewer' %}selected{% endif %}>Viewer</option>
                        </select>
                    </form>
                </td>
                {% endif %}

                <td class="text-right">
                    {% if u.role != 'admin' %}
                    <!-- Technician is allowed to delete non-technician, non-admin users -->
                    {% if u.role != 'technician' or session.get('role') == 'admin' %}
                    <form
                        action="{{ url_for('delete_user', user_id=u.id) }}"
                        method="post"
                        class="inline"
                    >
                        <button
                            class="btn btn-danger btn-sm"
                            onclick="return confirm('Delete user {{ u.username }}?')"
                        >
                            Delete
                        </button>
                    </form>
                    {% else %}
                    <span class="text-gray-600 text-sm">protected</span>
                    {% endif %}
                    {% else %}
                    <span class="text-gray-600 text-sm">protected</span>
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
      </div>
    </section>
    {% endif %}
  </main>
</div>
{% endblock %}
