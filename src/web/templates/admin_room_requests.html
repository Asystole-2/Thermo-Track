{% extends "layout.html" %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2">Room Condition Requests</h1>
                        <p class="text-text-muted">Monitor and manage room condition adjustment requests in real-time.</p>
                    </div>
                    {% include 'components/notification_bell.html' %}
                </div>
            </header>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 max-w-6xl mx-auto">
                <div class="bg-secondary p-4 rounded-xl border-l-4 border-accent-yellow">
                    <div class="text-2xl font-bold text-text-primary">{{ pending_count }}</div>
                    <div class="text-text-muted text-sm">Pending Requests</div>
                </div>
                <div class="bg-secondary p-4 rounded-xl border-l-4 border-accent-blue">
                    <div class="text-2xl font-bold text-text-primary">{{ viewed_count }}</div>
                    <div class="text-text-muted text-sm">Being Reviewed</div>
                </div>
                <div class="bg-secondary p-4 rounded-xl border-l-4 border-accent-green">
                    <div class="text-2xl font-bold text-text-primary">{{ approved_count }}</div>
                    <div class="text-text-muted text-sm">Approved Today</div>
                </div>
                <div class="bg-secondary p-4 rounded-xl border-l-4 border-accent-red">
                    <div class="text-2xl font-bold text-text-primary">{{ rooms_count }}</div>
                    <div class="text-text-muted text-sm">Active Rooms</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="max-w-6xl mx-auto mb-6">
                <div class="bg-secondary p-4 rounded-xl border border-border">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Status Filter -->
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">Status Filter</label>
                            <select id="status-filter" class="form-input text-sm py-2 bg-primary border-border w-full">
                                <option value="all">All Requests</option>
                                <option value="pending" selected>New Requests (Pending)</option>
                                <option value="viewed">Being Reviewed</option>
                                <option value="approved">Approved</option>
                                <option value="denied">Denied</option>
                            </select>
                        </div>

                        <!-- User Filter -->
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">User Filter</label>
                            <select id="user-filter" class="form-input text-sm py-2 bg-primary border-border w-full">
                                <option value="all">All Users</option>
                                <!-- Users will be populated dynamically -->
                            </select>
                        </div>

                        <!-- Request Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">Request Type</label>
                            <select id="type-filter" class="form-input text-sm py-2 bg-primary border-border w-full">
                                <option value="all">All Types</option>
                                <option value="temperature_change">Temperature Change</option>
                                <option value="fan_adjustment">Fan Adjustment</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-border">
                        <div class="text-sm text-text-muted" id="filter-stats">
                            Showing all requests
                        </div>
                        <div class="flex gap-2">
                            <button id="clear-filters"
                                    class="btn bg-tertiary hover:bg-tertiary-hover text-text-primary text-sm py-2 px-4">
                                Clear Filters
                            </button>
                            <button id="refresh-requests"
                                    class="btn bg-accent-blue hover:bg-accent-blue-hover text-white text-sm py-2 px-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Container -->
            <div id="requests-list" class="max-w-6xl mx-auto space-y-3">
                <div id="loading-indicator" class="text-center p-8">
                    <p class="text-text-secondary text-lg">Loading requests...</p>
                </div>
            </div>

            <!-- Action Modal -->
            <div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                <div class="bg-secondary p-6 rounded-xl shadow-2xl w-full max-w-md border border-border">
                    <h3 id="modal-title" class="text-xl font-bold mb-3 text-text-primary">Process Request</h3>
                    <div id="modal-content" class="space-y-4">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="modal-cancel-btn"
                                class="bg-tertiary hover:bg-tertiary-hover text-text-primary font-semibold py-2 px-4 rounded-lg transition duration-150">
                            Cancel
                        </button>
                        <button id="modal-confirm-btn"
                                class="bg-accent-blue hover:bg-accent-blue-hover text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .request-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .request-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .status-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background-color: var(--accent-yellow);
            color: white;
        }

        .status-viewed {
            background-color: var(--accent-blue);
            color: white;
        }

        .status-approved {
            background-color: var(--accent-green);
            color: white;
        }

        .status-denied {
            background-color: var(--accent-red);
            color: white;
        }

        .compact-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.75rem;
            align-items: start;
        }

        .request-main {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .request-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .detail-item {
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 140px;
        }

        .btn-compact {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
        }

        /* CSS Variables for Theme Support */
        :root {
            /* Light Mode Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --bg-tertiary-hover: #cbd5e0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-green: #10b981;
            --accent-green-hover: #059669;
            --accent-red: #ef4444;
            --accent-red-hover: #dc2626;
            --accent-yellow: #f59e0b;
            --accent-yellow-hover: #d97706;
            --border-color: #cbd5e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark {
            /* Dark Mode Colors */
            --bg-primary: #0d1117;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --bg-tertiary-hover: #4b5563;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-green: #10b981;
            --accent-green-hover: #059669;
            --accent-red: #ef4444;
            --accent-red-hover: #dc2626;
            --accent-yellow: #f59e0b;
            --accent-yellow-hover: #d97706;
            --border-color: #374151;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Apply CSS Variables to Tailwind-like Utility Classes */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .bg-tertiary-hover:hover { background-color: var(--bg-tertiary-hover); }

        .text-text-primary { color: var(--text-primary); }
        .text-text-secondary { color: var(--text-secondary); }
        .text-text-muted { color: var(--text-muted); }

        .border-border { border-color: var(--border-color); }

        .bg-accent-blue { background-color: var(--accent-blue); }
        .bg-accent-blue-hover:hover { background-color: var(--accent-blue-hover); }
        .bg-accent-green { background-color: var(--accent-green); }
        .bg-accent-green-hover:hover { background-color: var(--accent-green-hover); }
        .bg-accent-red { background-color: var(--accent-red); }
        .bg-accent-red-hover:hover { background-color: var(--accent-red-hover); }
        .bg-accent-yellow { background-color: var(--accent-yellow); }
        .bg-accent-yellow-hover:hover { background-color: var(--accent-yellow-hover); }

        .border-accent-blue { border-color: var(--accent-blue); }
        .border-accent-green { border-color: var(--accent-green); }
        .border-accent-red { border-color: var(--accent-red); }
        .border-accent-yellow { border-color: var(--accent-yellow); }
    </style>

    <script>
        let currentRequestId = null;
        let allRequests = [];
        let allUsers = new Set();

        // Load requests function
        async function loadRequests() {
            try {
                console.log('DEBUG: Loading requests from /api/admin/room-requests');

                const response = await fetch('/api/admin/room-requests');
                console.log('DEBUG: Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DEBUG: Server error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                allRequests = await response.json();
                console.log(`DEBUG: Received ${allRequests.length} requests:`, allRequests);

                // Extract unique users
                updateUserFilter(allRequests);

                // Apply initial filter (show pending by default)
                applyFilters();

            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requests-list').innerHTML = `
                    <div class="text-center p-8 bg-accent-red bg-opacity-20 rounded-xl">
                        <p class="text-accent-red font-semibold">Failed to load requests</p>
                        <p class="text-text-muted text-sm mt-2">${error.message}</p>
                        <button onclick="loadRequests()" class="btn bg-accent-blue text-white mt-4">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Update user filter dropdown
        function updateUserFilter(requests) {
            const userFilter = document.getElementById('user-filter');
            allUsers.clear();

            // Add "All Users" option
            userFilter.innerHTML = '<option value="all">All Users</option>';

            // Extract unique users
            requests.forEach(request => {
                if (request.username) {
                    allUsers.add(request.username);
                }
            });

            // Add user options
            allUsers.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userFilter.appendChild(option);
            });
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const userFilter = document.getElementById('user-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            let filteredRequests = allRequests.filter(request => {
                // Status filter
                if (statusFilter !== 'all' && request.status !== statusFilter) {
                    return false;
                }

                // User filter
                if (userFilter !== 'all' && request.username !== userFilter) {
                    return false;
                }

                // Type filter
                if (typeFilter !== 'all' && request.request_type !== typeFilter) {
                    return false;
                }

                return true;
            });

            // Update filter stats
            updateFilterStats(filteredRequests.length, allRequests.length);

            // Render filtered requests
            renderRequests(filteredRequests);
        }

        // Update filter statistics
        function updateFilterStats(filteredCount, totalCount) {
            const statsElement = document.getElementById('filter-stats');
            const statusFilter = document.getElementById('status-filter').value;
            const userFilter = document.getElementById('user-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            let statsText = `Showing ${filteredCount} of ${totalCount} requests`;

            const filters = [];
            if (statusFilter !== 'all') filters.push(`Status: ${statusFilter}`);
            if (userFilter !== 'all') filters.push(`User: ${userFilter}`);
            if (typeFilter !== 'all') filters.push(`Type: ${typeFilter.replace('_', ' ')}`);

            if (filters.length > 0) {
                statsText += ` (${filters.join(', ')})`;
            }

            statsElement.textContent = statsText;
        }

        // Render requests function
        function renderRequests(requests) {
            const listElement = document.getElementById('requests-list');
            const loadingIndicator = document.getElementById('loading-indicator');

            if (loadingIndicator) loadingIndicator.classList.add('hidden');
            listElement.innerHTML = '';

            if (requests.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center p-8 bg-secondary text-text-muted rounded-xl border border-border">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-green-500" viewBox="0 0 24 24" fill="currentColor">
    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
    <path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
</svg>
                        <h2 class="text-lg font-semibold text-text-primary mb-1">No new requests found</h2>
                        <p class="text-sm">Try adjusting your filters to see more results.</p>
                    </div>
                `;
                return;
            }

            requests.forEach(request => {
                const cardHtml = `
                    <div class="request-card bg-secondary p-4 rounded-xl border-l-4 ${
                        request.status === 'pending' ? 'border-accent-yellow' :
                        request.status === 'viewed' ? 'border-accent-blue' :
                        request.status === 'approved' ? 'border-accent-green' : 'border-accent-red'
                    }">
                        <div class="compact-grid">
                            <div class="request-main">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-lg font-bold text-text-primary mb-1 capitalize">
                                            ${request.room_name} - ${request.request_type.replace(/_/g, ' ')}
                                        </h3>
                                        <div class="request-meta">
                                            <span class="text-sm text-text-muted">
                                                By: <span class="text-text-secondary font-medium">${request.username}</span>
                                            </span>
                                            <span class="text-sm text-text-muted">
                                                ${new Date(request.created_at).toLocaleString()}
                                            </span>
                                            <span class="status-badge status-${request.status}">
                                                ${request.status}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="request-details">
                                    ${request.request_type === 'temperature_change' && request.current_temperature && request.target_temperature ? `
                                        <div class="detail-item">
                                            <div class="detail-label">Temperature Change</div>
                                            <div class="detail-value">
                                                ${request.current_temperature}°C → ${request.target_temperature}°C
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${request.request_type === 'fan_adjustment' && request.fan_level_request ? `
                                        <div class="detail-item">
                                            <div class="detail-label">Airflow Request</div>
                                            <div class="detail-value capitalize">
                                                ${request.fan_level_request.replace(/_/g, ' ')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${request.user_notes ? `
                                        <div class="detail-item">
                                            <div class="detail-label">User Notes</div>
                                            <div class="detail-value text-sm">"${request.user_notes}"</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="action-buttons">
                                ${request.status === 'pending' ? `
                                    <button onclick="markAsViewed('${request.id}')"
                                        class="btn-compact bg-accent-blue hover:bg-accent-blue-hover text-white font-semibold transition duration-150">
                                        Mark Viewed
                                    </button>
                                ` : ''}
                                <button onclick="showApproveModal('${request.id}')"
                                    class="btn-compact bg-accent-green hover:bg-accent-green-hover text-white font-semibold transition duration-150">
                                    Approve
                                </button>
                                <button onclick="showDenyModal('${request.id}')"
                                    class="btn-compact bg-accent-red hover:bg-accent-red-hover text-white font-semibold transition duration-150">
                                    Deny
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                listElement.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // Modal functions
        function showApproveModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('modal-title').textContent = 'Approve Request';
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <p class="text-text-secondary">Are you sure you want to approve this request?</p>
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-2">Estimated Completion Time:</label>
                        <input type="datetime-local" id="completion-time" class="w-full bg-tertiary border border-border rounded-lg px-3 py-2 text-text-primary text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-2">Admin Notes (optional):</label>
                        <textarea id="admin-notes" class="w-full bg-tertiary border border-border rounded-lg px-3 py-2 text-text-primary text-sm" rows="2"></textarea>
                    </div>
                </div>
            `;

            document.getElementById('modal-confirm-btn').onclick = () => approveRequest(requestId);
            document.getElementById('action-modal').classList.remove('hidden');
        }

        function showDenyModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('modal-title').textContent = 'Deny Request';
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-4">
                    <p class="text-text-secondary">Are you sure you want to deny this request?</p>
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-2">Reason for denial:</label>
                        <textarea id="denial-reason" class="w-full bg-tertiary border border-border rounded-lg px-3 py-2 text-text-primary text-sm" rows="2" placeholder="Provide a reason for denial..."></textarea>
                    </div>
                </div>
            `;

            document.getElementById('modal-confirm-btn').onclick = () => denyRequest(requestId);
            document.getElementById('action-modal').classList.remove('hidden');
        }

        // Action functions
        async function markAsViewed(requestId) {
            try {
                const response = await fetch(`/api/admin/room-requests/${requestId}/view`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || `HTTP ${response.status}: Failed to mark as viewed`);
                }

                loadRequests(); // Reload the list
                showToast('Request marked as viewed!', 'success');

            } catch (error) {
                console.error('Error marking as viewed:', error);
                showToast(`Failed to mark as viewed: ${error.message}`, 'error');
            }
        }

        async function approveRequest(requestId) {
            const completionTime = document.getElementById('completion-time').value;
            const adminNotes = document.getElementById('admin-notes').value;

            try {
                const response = await fetch(`/api/admin/room-requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        estimated_completion_time: completionTime,
                        admin_notes: adminNotes
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || `HTTP ${response.status}: Failed to approve request`);
                }

                closeModal();
                loadRequests();
                showToast('Request approved successfully!', 'success');

            } catch (error) {
                console.error('Error approving request:', error);
                showToast(`Failed to approve request: ${error.message}`, 'error');
            }
        }

        async function denyRequest(requestId) {
            const reason = document.getElementById('denial-reason').value;

            try {
                const response = await fetch(`/api/admin/room-requests/${requestId}/deny`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({reason: reason})
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || `HTTP ${response.status}: Failed to deny request`);
                }

                closeModal();
                loadRequests();
                showToast('Request denied successfully!', 'success');

            } catch (error) {
                console.error('Error denying request:', error);
                showToast(`Failed to deny request: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function closeModal() {
            document.getElementById('action-modal').classList.add('hidden');
            currentRequestId = null;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-sm">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DEBUG: Page loaded, starting to load requests...');

            // Load initial requests
            loadRequests();

            // Filter event listeners
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('user-filter').addEventListener('change', applyFilters);
            document.getElementById('type-filter').addEventListener('change', applyFilters);

            // Button event listeners
            document.getElementById('clear-filters').addEventListener('click', function() {
                document.getElementById('status-filter').value = 'pending';
                document.getElementById('user-filter').value = 'all';
                document.getElementById('type-filter').value = 'all';
                applyFilters();
            });

            document.getElementById('refresh-requests').addEventListener('click', loadRequests);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
        });
    </script>
{% endblock %}

{#comment for push#}