{% extends "layout.html" %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2"> My Notifications & Requests</h1>
                        <p class="header-subtitle text-gray-400">
                            Track all your room adjustment requests and system notifications
                        </p>
                    </div>
                </div>
            </header>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-4 border-l-4 border-blue-500">
                    <div class="text-2xl font-bold text-white">{{ total_requests }}</div>
                    <div class="text-sm text-gray-400">Total Requests</div>
                </div>
                <div class="card p-4 border-l-4 border-yellow-500">
                    <div class="text-2xl font-bold text-white">{{ pending_requests }}</div>
                    <div class="text-sm text-gray-400">Pending</div>
                </div>
                <div class="card p-4 border-l-4 border-green-500">
                    <div class="text-2xl font-bold text-white">{{ approved_requests }}</div>
                    <div class="text-sm text-gray-400">Approved</div>
                </div>
                <div class="card p-4 border-l-4 border-red-500">
                    <div class="text-2xl font-bold text-white">{{ denied_requests }}</div>
                    <div class="text-sm text-gray-400">Denied</div>
                </div>
            </div>

            <!-- Notifications Table -->
            <div class="card p-6 bg-secondary">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-text-primary">Recent Requests & Notifications</h2>
                    <div class="flex gap-2">
                        <button onclick="markAllAsRead()"
                                class="btn bg-accent-blue hover:bg-accent-blue-hover text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105 hover:shadow-lg text-sm">
                            Mark All as Read
                        </button>
                        <button onclick="loadNotifications()"
                                class="btn bg-tertiary hover:bg-tertiary-hover text-text-primary font-medium py-2 px-4 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105 hover:shadow-lg text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto border border-border rounded-lg">
                    <table class="w-full text-sm text-left text-text-muted">
                        <thead class="text-sm uppercase bg-tertiary text-text-primary border-b-2 border-border">
                        <tr>
                            <th class="px-6 py-4 font-semibold border-r border-border">Type</th>
                            <th class="px-6 py-4 font-semibold border-r border-border">Room</th>
                            <th class="px-6 py-4 font-semibold border-r border-border">Request Details</th>
                            <th class="px-6 py-4 font-semibold border-r border-border">Status</th>
                            <th class="px-6 py-4 font-semibold border-r border-border">Date</th>
                            <th class="px-6 py-4 font-semibold">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="notifications-table-body" class="divide-y divide-border">
                        <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="text-center py-12 hidden">
                    <svg class="w-16 h-16 mx-auto text-text-muted/60 mb-4" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-text-muted mb-2">No notifications yet</h3>
                    <p class="text-text-muted/80">Your room adjustment requests and system notifications will appear
                        here.</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-blue mx-auto"></div>
                    <p class="text-text-muted mt-2">Loading notifications...</p>
                </div>
            </div>
        </main>

        <!-- Request Details Modal -->
        <div id="requestDetailsModal"
             class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-2 sm:p-4">
            <div class="bg-secondary rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] sm:max-h-[80vh] overflow-hidden border border-border mx-2 sm:mx-0">
                <div class="flex items-center justify-between p-4 sm:p-6 border-b border-border">
                    <h3 class="text-lg font-semibold text-text-primary flex items-center gap-2">
                        <i class="fas fa-info-circle text-accent-blue"></i>
                        Request Details
                    </h3>
                    <button id="closeRequestDetailsModal"
                            class="text-text-muted hover:text-text-primary text-2xl sm:text-xl p-1">
                        &times;
                    </button>
                </div>

                <div class="p-4 sm:p-6 overflow-y-auto" style="max-height: calc(90vh - 140px);">
                    <div id="requestDetailsContent">
                        <!-- Dynamic content will be loaded here -->
                        <div class="text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-blue mx-auto"></div>
                            <p class="text-text-muted mt-2">Loading request details...</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-2 p-4 sm:p-6 border-t border-border">
                    <button id="closeRequestDetailsBtn"
                            class="btn bg-tertiary hover:bg-tertiary-hover text-text-primary flex items-center justify-center gap-2 w-full sm:w-auto order-2 sm:order-1">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load notifications on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadNotifications();
            initializeModalListeners();
        });

        function loadNotifications() {
            const tableBody = document.getElementById('notifications-table-body');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');

            tableBody.innerHTML = '';
            emptyState.classList.add('hidden');
            loadingState.classList.remove('hidden');

            fetch('/api/user/notifications')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load notifications');
                    return response.json();
                })
                .then(notifications => {
                    loadingState.classList.add('hidden');

                    if (notifications.length === 0) {
                        emptyState.classList.remove('hidden');
                        return;
                    }

                    notifications.forEach(notification => {
                        const row = document.createElement('tr');
                        row.className = `border-b border-gray-700 ${!notification.is_read ? 'bg-blue-900/20' : ''}`;

                        row.innerHTML = `
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full ${getNotificationColor(notification.type)}"></span>
                                    <span class="capitalize">${notification.type}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 font-medium text-white">${notification.room_name || '—'}</td>
                            <td class="px-4 py-3">
                                <div>
                                    <div class="font-medium text-white">${notification.title}</div>
                                    <div class="text-gray-500 text-xs">${notification.message}</div>
                                    ${notification.estimated_completion ? `
                                        <div class="flex items-center gap-1 text-yellow-400 text-xs mt-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Est: ${new Date(notification.estimated_completion).toLocaleString()}
                                        </div>
                                    ` : ''}
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(notification.request_status)}">
                                    ${notification.request_status ? notification.request_status.replace('_', ' ') : 'notification'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-gray-400">
                                ${new Date(notification.created_at).toLocaleDateString()}
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    ${!notification.is_read ? `
                                        <button onclick="markAsRead('${notification.id}')"
                                                class="text-blue-400 hover:text-blue-300 text-sm">
                                            Mark Read
                                        </button>
                                    ` : ''}
                                    ${notification.request_id ? `
                                        <button onclick="viewRequestDetails('${notification.request_id}')"
                                                class="text-green-400 hover:text-green-300 text-sm">
                                            Details
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        `;

                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                    loadingState.classList.add('hidden');
                    emptyState.innerHTML = `
                        <svg class="w-16 h-16 mx-auto text-red-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-400 mb-2">Failed to load notifications</h3>
                        <p class="text-gray-500">Please try refreshing the page.</p>
                    `;
                    emptyState.classList.remove('hidden');
                });
        }

        function getNotificationColor(type) {
            const colors = {
                'success': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            return colors[type] || 'bg-gray-500';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'viewed': 'bg-blue-500/20 text-blue-400',
                'approved': 'bg-green-500/20 text-green-400',
                'denied': 'bg-red-500/20 text-red-400',
                'completed': 'bg-gray-500/20 text-gray-400'
            };
            return classes[status] || 'bg-gray-500/20 text-gray-400';
        }

        function markAsRead(notificationId) {
            fetch(`/api/user/notifications/${notificationId}/read`, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        loadNotifications();
                        // Update the notification bell count
                        if (window.notificationSystem) {
                            window.notificationSystem.loadNotificationCount();
                        }
                    }
                })
                .catch(error => console.error('Error marking as read:', error));
        }

        function markAllAsRead() {
            fetch('/api/user/notifications/mark-all-read', {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        loadNotifications();
                        // Update the notification bell count
                        if (window.notificationSystem) {
                            window.notificationSystem.loadNotificationCount();
                        }
                    }
                })
                .catch(error => console.error('Error marking all as read:', error));
        }

        // Request Details Modal Functions
        function showRequestDetailsModal() {
            const modal = document.getElementById('requestDetailsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function hideRequestDetailsModal() {
            const modal = document.getElementById('requestDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function viewRequestDetails(requestId) {
            console.log('Loading details for request:', requestId);
            showRequestDetailsModal();

            // Show loading state
            const content = document.getElementById('requestDetailsContent');
            content.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-blue mx-auto"></div>
            <p class="text-text-muted mt-2">Loading request details...</p>
        </div>
    `;

            // Load request details
            fetch(`/api/requests/${requestId}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Request not found');
                        } else if (response.status === 401) {
                            throw new Error('Please log in to view request details');
                        } else if (response.status === 500) {
                            throw new Error('Server error - please try again later');
                        } else {
                            throw new Error(`Error: ${response.status} ${response.statusText}`);
                        }
                    }
                    return response.json();
                })
                .then(request => {
                    if (request.error) {
                        throw new Error(request.error);
                    }
                    displayRequestDetails(request);
                })
                .catch(error => {
                    console.error('Error loading request details:', error);
                    displayRequestDetailsError(error.message);
                });
        }

        function displayRequestDetailsError(errorMessage) {
            const content = document.getElementById('requestDetailsContent');
            content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
            <h3 class="text-lg font-semibold text-text-primary mb-2">Unable to Load Details</h3>
            <p class="text-text-muted text-sm mb-4">
                ${errorMessage}
            </p>
            <p class="text-text-muted text-xs mb-4">
                If this problem persists, please contact support.
            </p>
            <div class="flex gap-2 justify-center">
                <button onclick="hideRequestDetailsModal()"
                        class="btn bg-tertiary hover:bg-tertiary-hover text-text-primary">
                    Close
                </button>
                <button onclick="viewRequestDetails(${window.lastRequestId || '3'})"
                        class="btn bg-accent-blue hover:bg-accent-blue-hover text-white">
                    Try Again
                </button>
            </div>
        </div>
    `;
        }

        // Store the last request ID for retry functionality
        let lastRequestId = null;

        function viewRequestDetails(requestId) {
            lastRequestId = requestId;
            console.log('Loading details for request:', requestId);
            showRequestDetailsModal();

            const content = document.getElementById('requestDetailsContent');
            content.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-blue mx-auto"></div>
            <p class="text-text-muted mt-2">Loading request details...</p>
            <p class="text-text-muted text-xs mt-1">Request ID: ${requestId}</p>
        </div>
    `;

            // Test both endpoints
            Promise.any([
                fetch(`/api/requests/${requestId}`).then(r => r.ok ? r.json() : Promise.reject('Main API failed')),
                fetch(`/api/debug/requests/${requestId}`).then(r => r.ok ? r.json() : Promise.reject('Debug API failed'))
            ])
                .then(data => {
                    console.log('API Response:', data);
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    // Handle debug endpoint response format
                    const requestData = data.data || data;
                    displayRequestDetails(requestData);
                })
                .catch(error => {
                    console.error('All API attempts failed:', error);
                    // Show fallback with error details
                    const detailsButton = document.querySelector(`button[onclick*="viewRequestDetails('${requestId}')"]`);
                    let fallbackData = null;

                    if (detailsButton) {
                        const row = detailsButton.closest('tr');
                        if (row) {
                            fallbackData = extractNotificationData(row, requestId);
                        }
                    }

                    if (fallbackData) {
                        displayFallbackRequestDetails(fallbackData, error.message);
                    } else {
                        displayRequestDetailsError(error.message);
                    }
                });
        }

        function displayFallbackRequestDetails(notification, errorMsg = null) {
            const content = document.getElementById('requestDetailsContent');
            const statusBadgeClass = getStatusBadgeClass(notification.status.toLowerCase());

            content.innerHTML = `
        <div class="space-y-6">
            ${errorMsg ? `
            <div class="p-4 bg-accent-red/10 rounded-lg border border-accent-red/20">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-exclamation-triangle text-accent-red"></i>
                    <span class="font-semibold text-text-primary">API Error</span>
                </div>
                <p class="text-text-secondary text-sm">
                    ${errorMsg}
                </p>
            </div>
            ` : ''}

            <div class="p-4 bg-accent-yellow/10 rounded-lg border border-accent-yellow/20">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-info-circle text-accent-yellow"></i>
                    <span class="font-semibold text-text-primary">Limited Information Available</span>
                </div>
                <p class="text-text-secondary text-sm">
                    Showing basic information from notification. Detailed request data is temporarily unavailable.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-tertiary rounded-lg">
                <div>
                    <h4 class="font-semibold text-text-primary mb-2">Room Information</h4>
                    <p class="text-text-secondary text-sm">
                        <strong>Room:</strong> ${notification.room_name}<br>
                        <strong>Request ID:</strong> ${notification.id}
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold text-text-primary mb-2">Request Status</h4>
                    <p class="text-text-secondary text-sm">
                        <strong>Status:</strong>
                        <span class="px-2 py-1 text-xs rounded-full ${statusBadgeClass} ml-1">
                            ${notification.status}
                        </span><br>
                        <strong>Created:</strong> ${notification.created_at}
                    </p>
                </div>
            </div>

            <div class="p-4 bg-tertiary rounded-lg">
                <h4 class="font-semibold text-text-primary mb-2">Request Summary</h4>
                <div class="space-y-2">
                    <div>
                        <strong class="text-text-secondary">Title:</strong><br>
                        <span class="text-text-primary">${notification.title}</span>
                    </div>
                    <div>
                        <strong class="text-text-secondary">Description:</strong><br>
                        <span class="text-text-primary">${notification.message}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
        }

        function extractNotificationData(row, requestId) {
            const cells = row.querySelectorAll('td');
            return {
                id: requestId,
                room_name: cells[1].textContent.trim(),
                title: cells[2].querySelector('.font-medium')?.textContent.trim() || 'Request Details',
                message: cells[2].querySelector('.text-gray-500')?.textContent.trim() || 'No additional information available',
                status: cells[3].querySelector('span')?.textContent.trim() || 'unknown',
                created_at: cells[4].textContent.trim() || new Date().toLocaleDateString()
            };
        }

        function displayFallbackRequestDetails(notification) {
            const content = document.getElementById('requestDetailsContent');
            const statusBadgeClass = getStatusBadgeClass(notification.status.toLowerCase());

            content.innerHTML = `
        <div class="space-y-6">
            <div class="p-4 bg-accent-yellow/10 rounded-lg border border-accent-yellow/20">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-info-circle text-accent-yellow"></i>
                    <span class="font-semibold text-text-primary">Limited Information Available</span>
                </div>
                <p class="text-text-secondary text-sm">
                    Showing basic information from notification. Detailed request data is temporarily unavailable.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-tertiary rounded-lg">
                <div>
                    <h4 class="font-semibold text-text-primary mb-2">Room Information</h4>
                    <p class="text-text-secondary text-sm">
                        <strong>Room:</strong> ${notification.room_name}<br>
                        <strong>Request ID:</strong> ${notification.id}
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold text-text-primary mb-2">Request Status</h4>
                    <p class="text-text-secondary text-sm">
                        <strong>Status:</strong>
                        <span class="px-2 py-1 text-xs rounded-full ${statusBadgeClass} ml-1">
                            ${notification.status}
                        </span><br>
                        <strong>Created:</strong> ${notification.created_at}
                    </p>
                </div>
            </div>

            <div class="p-4 bg-tertiary rounded-lg">
                <h4 class="font-semibold text-text-primary mb-2">Request Summary</h4>
                <div class="space-y-2">
                    <div>
                        <strong class="text-text-secondary">Title:</strong><br>
                        <span class="text-text-primary">${notification.title}</span>
                    </div>
                    <div>
                        <strong class="text-text-secondary">Description:</strong><br>
                        <span class="text-text-primary">${notification.message}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
        }

        function displayRequestDetails(request) {
            const content = document.getElementById('requestDetailsContent');

            // Format the request data for display
            const formattedDate = new Date(request.created_at).toLocaleString();
            const statusBadgeClass = getStatusBadgeClass(request.status);
            const temperatureUnit = request.temperature_unit || 'celsius';
            const tempSymbol = temperatureUnit === 'celsius' ? '°C' : temperatureUnit === 'fahrenheit' ? '°F' : 'K';

            content.innerHTML = `
        <div class="space-y-4 sm:space-y-6">
            <!-- Header Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 p-3 sm:p-4 bg-tertiary rounded-lg">
                <div class="space-y-2">
                    <h4 class="font-semibold text-text-primary flex items-center gap-2 text-sm sm:text-base">
                        <i class="fas fa-door-open text-accent-blue"></i>
                        Room Information
                    </h4>
                    <div class="text-text-secondary text-xs sm:text-sm space-y-1">
                        <div class="flex flex-wrap gap-1">
                            <strong class="min-w-[60px]">Room:</strong>
                            <span>${request.room_name || 'N/A'}</span>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            <strong class="min-w-[60px]">Location:</strong>
                            <span>${request.room_location || 'Not specified'}</span>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <h4 class="font-semibold text-text-primary flex items-center gap-2 text-sm sm:text-base">
                        <i class="fas fa-calendar text-accent-blue"></i>
                        Request Information
                    </h4>
                    <div class="text-text-secondary text-xs sm:text-sm space-y-1">
                        <div class="flex flex-wrap gap-1">
                            <strong class="min-w-[80px]">Submitted:</strong>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-1">
                            <strong class="min-w-[50px]">Status:</strong>
                            <span class="px-2 py-1 text-xs rounded-full ${statusBadgeClass}">
                                ${request.status ? request.status.replace('_', ' ') : 'unknown'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Request Details -->
            <div class="p-3 sm:p-4 bg-tertiary rounded-lg">
                <h4 class="font-semibold text-text-primary mb-3 flex items-center gap-2 text-sm sm:text-base">
                    <i class="fas fa-clipboard-list text-accent-blue"></i>
                    Request Details
                </h4>

                ${request.request_type === 'temperature_change' ? `
                    <div class="space-y-2 sm:space-y-3 text-xs sm:text-sm">
                        <div class="flex flex-col xs:flex-row justify-between gap-1">
                            <span class="text-text-secondary min-w-[140px]">Request Type:</span>
                            <span class="text-text-primary font-medium">Temperature Adjustment</span>
                        </div>
                        ${request.target_temperature ? `
                            <div class="flex flex-col xs:flex-row justify-between gap-1">
                                <span class="text-text-secondary min-w-[140px]">Requested Temperature:</span>
                                <span class="text-text-primary font-medium">
                                    ${request.target_temperature}${tempSymbol}
                                </span>
                            </div>
                        ` : ''}
                        ${request.current_temperature ? `
                            <div class="flex flex-col xs:flex-row justify-between gap-1">
                                <span class="text-text-secondary min-w-[140px]">Current Temperature:</span>
                                <span class="text-text-primary font-medium">
                                    ${request.current_temperature}${tempSymbol}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : request.request_type === 'fan_adjustment' ? `
                    <div class="space-y-2 sm:space-y-3 text-xs sm:text-sm">
                        <div class="flex flex-col xs:flex-row justify-between gap-1">
                            <span class="text-text-secondary min-w-[140px]">Request Type:</span>
                            <span class="text-text-primary font-medium">Fan/Airflow Adjustment</span>
                        </div>
                        ${request.fan_level_request ? `
                            <div class="flex flex-col xs:flex-row justify-between gap-1">
                                <span class="text-text-secondary min-w-[140px]">Requested Adjustment:</span>
                                <span class="text-text-primary font-medium capitalize">
                                    ${request.fan_level_request.replace('_', ' ')}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div class="text-text-secondary text-xs sm:text-sm">No specific request details available.</div>
                `}
            </div>

            <!-- User Notes -->
            ${request.user_notes ? `
                <div class="p-3 sm:p-4 bg-tertiary rounded-lg">
                    <h4 class="font-semibold text-text-primary mb-2 flex items-center gap-2 text-sm sm:text-base">
                        <i class="fas fa-edit text-accent-blue"></i>
                        Additional Notes
                    </h4>
                    <p class="text-text-secondary text-xs sm:text-sm bg-secondary p-3 rounded border border-border whitespace-pre-wrap break-words">
                        ${request.user_notes}
                    </p>
                </div>
            ` : ''}

            <!-- Estimated Completion -->
            ${request.estimated_completion_time ? `
                <div class="p-3 sm:p-4 bg-accent-yellow/10 rounded-lg border border-accent-yellow/20">
                    <h4 class="font-semibold text-text-primary mb-2 flex items-center gap-2 text-sm sm:text-base">
                        <i class="fas fa-clock text-accent-yellow"></i>
                        Estimated Completion
                    </h4>
                    <p class="text-text-secondary text-xs sm:text-sm">
                        ${new Date(request.estimated_completion_time).toLocaleString()}
                    </p>
                </div>
            ` : ''}

            <!-- Technical Details -->
            <div class="p-3 sm:p-4 bg-tertiary rounded-lg">
                <h4 class="font-semibold text-text-primary mb-3 flex items-center gap-2 text-sm sm:text-base">
                    <i class="fas fa-cog text-accent-blue"></i>
                    Technical Information
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 text-xs sm:text-sm">
                    <div class="break-all">
                        <span class="text-text-secondary">Request ID:</span><br>
                        <code class="text-text-primary font-mono text-xs">${request.id}</code>
                    </div>
                    <div>
                        <span class="text-text-secondary">Room ID:</span><br>
                        <span class="text-text-primary">${request.room_id}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
        }

        function displayRequestDetailsError() {
            const content = document.getElementById('requestDetailsContent');
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-accent-red mb-4"></i>
                    <h3 class="text-lg font-semibold text-text-primary mb-2">Failed to Load Details</h3>
                    <p class="text-text-muted text-sm mb-4">
                        Unable to load request details. Please try again later.
                    </p>
                    <button onclick="hideRequestDetailsModal()"
                            class="btn bg-accent-blue hover:bg-accent-blue-hover text-white">
                        Close
                    </button>
                </div>
            `;
        }

        function initializeModalListeners() {
            const modal = document.getElementById('requestDetailsModal');
            const closeBtn = document.getElementById('closeRequestDetailsModal');
            const closeBtn2 = document.getElementById('closeRequestDetailsBtn');

            if (closeBtn) closeBtn.addEventListener('click', hideRequestDetailsModal);
            if (closeBtn2) closeBtn2.addEventListener('click', hideRequestDetailsModal);

            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) hideRequestDetailsModal();
                });
            }

            // Add keyboard event listener for ESC key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    hideRequestDetailsModal();
                }
            });
        }

        function focusOnUserRequest(requestId) {
            console.log('DEBUG: Focusing on user request:', requestId);

            // Find the request in the user's request list and highlight it
            const requestElement = document.querySelector(`[data-request-id="${requestId}"]`);
            if (requestElement) {
                requestElement.scrollIntoView({behavior: 'smooth', block: 'center'});

                // Add highlight
                requestElement.style.transition = 'all 0.5s ease';
                requestElement.style.boxShadow = '0 0 0 3px var(--accent-blue)';
                requestElement.style.transform = 'scale(1.02)';

                setTimeout(() => {
                    requestElement.style.boxShadow = '';
                    requestElement.style.transform = '';
                }, 3000);
            }
        }

        // Check URL parameters on page load
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const notificationId = urlParams.get('notification_id');

            if (notificationId) {
                // Mark the specific notification as read
                fetch(`/api/user/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
            }
        });
    </script>

    <style>
        @media (max-width: 480px) {
            #requestDetailsModal > div {
                margin: 0.25rem;
                border-radius: 0.5rem;
            }

            #requestDetailsModal .p-4 {
                padding: 0.75rem;
            }
        }

        /* Enhanced button styles */
        .btn {
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.17);
        }

        /* Table header enhancements */
        thead th {
            font-size: 0.875rem; /* text-sm equivalent but slightly larger than body */
            letter-spacing: 0.025em;
        }

        /* Table cell padding */
        tbody td {
            padding: 0.75rem 1.5rem; /* px-6 py-3 equivalent */
            font-size: 0.875rem; /* text-sm */
            vertical-align: middle;
        }

        /* Hover effect for table rows */
        tbody tr {
            transition: background-color 0.15s ease-in-out;
        }

        tbody tr:hover {
            background-color: var(--bg-tertiary);
        }

        /* Ensure proper contrast for table headers */
        thead {
            background-color: var(--bg-tertiary);
        }

        /* Border styling for better separation */
        .border-border {
            border-color: var(--border-color);
        }

        .divide-border > * + * {
            border-color: var(--border-color);
        }

        /* Modal Styles */
        #requestDetailsModal {
            backdrop-filter: blur(4px);
        }

        #requestDetailsModal > div {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Scrollbar styling for modal content */
        #requestDetailsModal .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        #requestDetailsModal .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }

        #requestDetailsModal .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }

        #requestDetailsModal .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        /* Ensure modal is above other content */
        #requestDetailsModal {
            z-index: 1000;
        }
    </style>{% endblock %}