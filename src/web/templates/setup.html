{% extends "layout.html" %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <!-- Header -->
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2">System Setup</h1>
                        <p class="header-subtitle">
                            {% if session.role in ['admin', 'technician'] %}
                                Manage all rooms and devices system-wide.
                            {% else %}
                                Create and manage your rooms.
                            {% endif %}
                        </p>
                    </div>

                    <div class="flex items-center gap-3">
                        {% if session.role in ['admin', 'technician'] %}
                            <button id="openAddDeviceModal"
                                    class="btn p-2 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded">
                                + Add Device
                            </button>
                        {% endif %}
                        {% include 'components/notification_bell.html' %}
                    </div>
                </div>
            </header>

            <!-- Search Bar (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
            <section class="mb-6">
                <div class="card p-4">
                    <div class="relative">
                        <input
                            type="text"
                            id="roomSearchInput"
                            placeholder="Search rooms by name, location, or devices..."
                            class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        >
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Room Management Filters (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
            <section class="mb-6">
                <div class="card p-4">
                    <div class="flex flex-wrap gap-2">
                        <button id="filterMyRooms" class="filter-room-btn active px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-blue-600 text-white" data-filter="my-rooms">
                            My Rooms ({{ user_rooms|length }})
                        </button>
                        <button id="filterAvailableRooms" class="filter-room-btn inactive px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-gray-600 text-gray-300" data-filter="available-rooms">
                            Available Rooms ({{ available_rooms|length }})
                        </button>
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Create Room (Technician and Admin) -->
            {% if session.role in ['admin', 'technician'] %}
            <section class="mb-6" id="createRoomSection">
                <h3 class="text-xl font-semibold mb-4 text-gray-300">
                    Create a new room
                </h3>

                <form
                    action="{{ url_for('setuprooms_create') }}"
                    method="post"
                    class="card p-4"
                >
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="room_name" class="form-label">Room Name</label>
                            <input
                                id="room_name"
                                name="room_name"
                                type="text"
                                class="form-input"
                                placeholder="e.g. Chemistry Lab 2"
                                required
                            />
                        </div>

                        <div class="md:col-span-1">
                            <label for="room_location" class="form-label"
                                >Location (optional)</label
                            >
                            <input
                                id="room_location"
                                name="room_location"
                                type="text"
                                class="form-input"
                                placeholder="e.g. Building B"
                            />
                        </div>

                        <div class="md:col-span-1">
                            <button type="submit" class="btn btn-primary w-full">
                                Add Room
                            </button>
                        </div>
                    </div>
                </form>
            </section>
            {% endif %}

            <!-- My Rooms Section (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
            <section id="myRoomsSection" class="room-section">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-300">My Rooms</h3>
                    <span class="text-xs text-gray-400 room-count">
                        Showing <span id="myRoomsCount">{{ user_rooms|length }}</span> of {{ user_rooms|length }} room{% if user_rooms|length != 1 %}s{% endif %}
                    </span>
                </div>

                {% if user_rooms and user_rooms|length > 0 %}
                <div class="card p-5 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left">Room Name</th>
                                    <th class="text-left">Location</th>
                                    <th class="text-center">Devices</th>
                                    <th class="text-center">Avg Temp</th>
                                    <th class="text-center">Avg Humidity</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRoomsTable">
                                {% for r in user_rooms %}
                                <tr class="room-row" data-room-name="{{ r.room_name.lower() }}" data-location="{{ (r.location or '').lower() }}" data-devices="{{ r.devices_count }}">
                                    <td class="whitespace-nowrap">
                                        <a href="{{ url_for('room', room_id=r.id) }}" class="text-blue-400 hover:text-blue-300 font-medium">
                                            {{ r.room_name }}
                                        </a>
                                    </td>
                                    <td class="whitespace-nowrap text-gray-400">
                                        {{ r.location or '—' }}
                                    </td>
                                    <td class="text-center">{{ r.devices_count or 0 }}</td>
                                    <td class="text-center">
                                        {% if r.avg_temp is not none %} {{ '%.1f'|format(r.avg_temp) }}°C {% else %}—{% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if r.avg_humidity is not none %} {{ '%.1f'|format(r.avg_humidity) }}% {% else %}—{% endif %}
                                    </td>
                                    <td class="text-right">
                                        <div class="flex justify-end gap-2">
                                            <a href="{{ url_for('room', room_id=r.id) }}"
                                               class="btn btn-primary btn-sm">
                                                View
                                            </a>
                                            <form action="{{ url_for('dashboard_remove_room', room_id=r.id) }}"
                                                  method="post"
                                                  class="inline">
                                                <button type="submit"
                                                        class="btn btn-danger btn-sm"
                                                        onclick="return confirm('Remove {{ r.room_name }} from your rooms?')">
                                                    Remove
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="card p-8 text-center">
                    <svg class="w-16 h-16 text-gray-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">No Rooms Added</h3>
                    <p class="text-gray-400 text-sm mb-4">
                        You haven't added any rooms to your dashboard yet.
                    </p>
                    <p class="text-gray-400 text-sm">
                        Use the "Available Rooms" tab to find and add rooms.
                    </p>
                </div>
                {% endif %}
            </section>
            {% endif %}

            <!-- Available Rooms Section (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
            <section id="availableRoomsSection" class="room-section hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-300">Available Rooms</h3>
                    <span class="text-xs text-gray-400 room-count">
                        Showing <span id="availableRoomsCount">{{ available_rooms|length }}</span> of {{ available_rooms|length }} room{% if available_rooms|length != 1 %}s{% endif %} available
                    </span>
                </div>

                {% if available_rooms and available_rooms|length > 0 %}
                <div class="card p-5 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left">Room Name</th>
                                    <th class="text-left">Location</th>
                                    <th class="text-center">Devices</th>
                                    <th class="text-center">Avg Temp</th>
                                    <th class="text-center">Avg Humidity</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="availableRoomsTable">
                                {% for r in available_rooms %}
                                <tr class="room-row" data-room-name="{{ r.room_name.lower() }}" data-location="{{ (r.location or '').lower() }}" data-devices="{{ r.devices_count }}">
                                    <td class="whitespace-nowrap">
                                        <a href="{{ url_for('room', room_id=r.id) }}" class="text-blue-400 hover:text-blue-300 font-medium">
                                            {{ r.room_name }}
                                        </a>
                                    </td>
                                    <td class="whitespace-nowrap text-gray-400">
                                        {{ r.location or '—' }}
                                    </td>
                                    <td class="text-center">{{ r.devices_count or 0 }}</td>
                                    <td class="text-center">
                                        {% if r.avg_temp is not none %} {{ '%.1f'|format(r.avg_temp) }}°C {% else %}—{% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if r.avg_humidity is not none %} {{ '%.1f'|format(r.avg_humidity) }}% {% else %}—{% endif %}
                                    </td>
                                    <td class="text-right">
                                        <form action="{{ url_for('dashboard_add_room', room_id=r.id) }}"
                                              method="post"
                                              class="inline">
                                            <button type="submit"
                                                    class="btn btn-primary btn-sm">
                                                Add to My Rooms
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="card p-8 text-center">
                    <svg class="w-16 h-16 text-gray-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">No Available Rooms</h3>
                    <p class="text-gray-400 text-sm">
                        There are no additional rooms available to add to your dashboard.
                    </p>
                </div>
                {% endif %}
            </section>
            {% endif %}

            <!-- All Rooms Section (Admin/Technician only) - NO FILTERS -->
            {% if session.role in ['admin', 'technician'] %}
            <section id="allRoomsSection">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-300">All System Rooms</h3>
                    <span class="text-xs text-gray-400 room-count">
                        {{ all_rooms|length }} room{% if all_rooms|length != 1 %}s{% endif %} total
                    </span>
                </div>

                {% if all_rooms and all_rooms|length > 0 %}
                <div class="card p-5 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left">Room Name</th>
                                    <th class="text-left">Location</th>
                                    <th class="text-center">Devices</th>
                                    <th class="text-center">With Readings</th>
                                    <th class="text-center">Avg Temp</th>
                                    <th class="text-center">Avg Humidity</th>
                                    <th class="text-center">Last Update</th>
                                    <th class="text-center">Owner</th>
                                    {% if session.role == 'admin' %}
                                    <th class="text-right">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in all_rooms %}
                                <tr>
                                    <td class="whitespace-nowrap">
                                        <a href="{{ url_for('room', room_id=r.id) }}" class="text-blue-400 hover:text-blue-300 font-medium">
                                            {{ r.room_name }}
                                        </a>
                                    </td>
                                    <td class="whitespace-nowrap text-gray-400">
                                        {{ r.location or '—' }}
                                    </td>
                                    <td class="text-center">{{ r.devices_count or 0 }}</td>
                                    <td class="text-center">{{ r.devices_with_readings or 0 }}</td>
                                    <td class="text-center">
                                        {% if r.avg_temp is not none %} {{ '%.1f'|format(r.avg_temp) }}°C {% else %}—{% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if r.avg_humidity is not none %} {{ '%.1f'|format(r.avg_humidity) }}% {% else %}—{% endif %}
                                    </td>
                                    <td class="text-center whitespace-nowrap">
                                        {% if r.last_update %} {{ (r.last_update|string).replace('T',' ') }} {% else %}—{% endif %}
                                    </td>
                                    <td class="text-center">
                                        {{ r.owner_username or '—' }}
                                    </td>
                                    {% if session.role == 'admin' %}
                                    <td class="text-right">
                                        <form
                                            action="{{ url_for('setuprooms_delete', room_id=r.id) }}"
                                            method="post"
                                            class="inline"
                                        >
                                            <button
                                                type="submit"
                                                class="btn btn-danger btn-sm"
                                                onclick="return confirm('Delete {{ r.room_name }}?')"
                                            >
                                                Delete
                                            </button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="card p-8 text-center">
                    <svg class="w-16 h-16 text-gray-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">No Rooms Found</h3>
                    <p class="text-gray-400 text-sm">
                        No rooms have been created yet.
                    </p>
                </div>
                {% endif %}
            </section>
            {% endif %}

            <!-- Add Device Modal (Technician and Admin) -->
            {% if session.role in ['admin', 'technician'] %}
            <div
                id="addDeviceModal"
                class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50"
            >
                <div
                    class="bg-gray-900 rounded-xl shadow-xl w-full max-w-lg p-6 border border-gray-700"
                >
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-200">Add Device</h3>
                        <button
                            id="closeAddDeviceModal"
                            class="text-gray-400 hover:text-gray-200"
                        >
                            &times;
                        </button>
                    </div>

                    <form
                        method="post"
                        action="{{ url_for('add_device') }}"
                        class="space-y-4"
                    >
                        <div>
                            <label class="form-label">Room</label>
                            <select name="room_id" class="form-input" required>
                                <option value="" disabled selected>Select a room</option>
                                {% for r in all_rooms %}
                                <option value="{{ r.id }}">{{ r.room_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Device Name</label>
                            <input type="text" name="name" class="form-input" required />
                        </div>

                        <div>
                            <label class="form-label">Device UID</label>
                            <input type="text" name="device_uid" class="form-input" required />
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="form-label">Type</label>
                                <input type="text" name="type" class="form-input" />
                            </div>
                            <div>
                                <label class="form-label">Status</label>
                                <select name="status" class="form-input">
                                    <option value="active">active</option>
                                    <option value="inactive">inactive</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 pt-2">
                            <button
                                type="button"
                                id="cancelAddDevice"
                                class="btn bg-gray-700 hover:bg-gray-600"
                            >
                                Cancel
                            </button>
                            <button class="btn btn-primary">Save Device</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Search and Filter Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Only initialize filters and search for regular users
            {% if session.role not in ['admin', 'technician'] %}
            const filterButtons = document.querySelectorAll('.filter-room-btn');
            const roomSections = document.querySelectorAll('.room-section');
            const searchInput = document.getElementById('roomSearchInput');
            let currentFilter = 'my-rooms';

            function showSection(sectionId) {
                // Hide all sections
                roomSections.forEach(section => {
                    section.classList.add('hidden');
                });

                // Show selected section
                const targetSection = document.getElementById(sectionId + 'Section');
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }

                // Update button states
                filterButtons.forEach(btn => {
                    if (btn.dataset.filter === sectionId) {
                        btn.classList.remove('inactive', 'bg-gray-600', 'text-gray-300');
                        btn.classList.add('active', 'bg-blue-600', 'text-white');
                    } else {
                        btn.classList.remove('active', 'bg-blue-600', 'text-white');
                        btn.classList.add('inactive', 'bg-gray-600', 'text-gray-300');
                    }
                });

                currentFilter = sectionId;
                filterRooms();
            }

            function filterRooms() {
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const tableId = currentFilter === 'my-rooms' ? 'myRoomsTable' : 'availableRoomsTable';
                const countId = currentFilter === 'my-rooms' ? 'myRoomsCount' : 'availableRoomsCount';

                const rows = document.querySelectorAll(`#${tableId} .room-row`);
                let visibleCount = 0;

                rows.forEach(row => {
                    const roomName = row.dataset.roomName || '';
                    const location = row.dataset.location || '';
                    const devices = row.dataset.devices || '';

                    const matchesSearch = !searchTerm ||
                        roomName.includes(searchTerm) ||
                        location.includes(searchTerm) ||
                        devices.includes(searchTerm);

                    if (matchesSearch) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Update count display
                const countElement = document.getElementById(countId);
                if (countElement) {
                    countElement.textContent = visibleCount;
                }
            }

            // Add event listeners to filter buttons
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    showSection(this.dataset.filter);
                });
            });

            // Add event listener to search input
            if (searchInput) {
                searchInput.addEventListener('input', filterRooms);
            }

            // Show my-rooms by default
            showSection('my-rooms');
            {% endif %}
        });
    </script>

    <!-- Modal Script -->
    <script>
        (function () {
            const open = document.getElementById("openAddDeviceModal");
            const modal = document.getElementById("addDeviceModal");
            const close = document.getElementById("closeAddDeviceModal");
            const cancel = document.getElementById("cancelAddDevice");

            function show() {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
            }

            function hide() {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            if (open) open.addEventListener("click", show);
            if (close) close.addEventListener("click", hide);
            if (cancel) cancel.addEventListener("click", hide);
            if (modal)
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) hide();
                });
        })();
    </script>
{% endblock %}