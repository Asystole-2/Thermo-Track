{% extends "layout.html" %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <!-- Header -->
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2">System Setup</h1>
                        <p class="header-subtitle">
                            Create and manage rooms.
                        </p>
                    </div>

                    <div class="flex items-center gap-3">
                        {% if session.role in ['admin', 'technician'] %}
                            <button id="openAddDeviceModal"
                                    class="btn p-2 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded">
                                + Add Device
                            </button>
                        {% endif %} {% include 'components/notification_bell.html' %}
                    </div>
                </div>
            </header>

    <!-- Create Room (Technician and Admin) -->
    {% if session.role in ['admin', 'technician'] %}
    <section class="mb-6">
      <h3 class="text-xl font-semibold mb-4 text-gray-300">
        Create a new room
      </h3>

      <form
        action="{{ url_for('setuprooms_create') }}"
        method="post"
        class="card p-4"
      >
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div class="md:col-span-2">
            <label for="room_name" class="form-label">Room Name</label>
            <input
              id="room_name"
              name="room_name"
              type="text"
              class="form-input"
              placeholder="e.g. Chemistry Lab 2"
              required
            />
          </div>

          <div class="md:col-span-1">
            <label for="room_location" class="form-label"
              >Location (optional)</label
            >
            <input
              id="room_location"
              name="room_location"
              type="text"
              class="form-input"
              placeholder="e.g. Building B"
            />
          </div>

          <div class="md:col-span-1">
            <button type="submit" class="btn btn-primary w-full">
              Add Room
            </button>
          </div>
        </div>
      </form>
    </section>
    {% endif %}

    <!-- Existing Rooms -->
    <section>
      <h3 class="text-xl font-semibold mb-4 text-gray-300">Existing Rooms</h3>
      <div class="card p-5 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="table w-full">
            <thead>
              <tr>
                <th class="text-left">Room Name</th>
                <th class="text-left">Location</th>
                <th class="text-center">Devices</th>
                <th class="text-center">With Readings</th>
                <th class="text-center">Avg Temp</th>
                <th class="text-center">Avg Humidity</th>
                <th class="text-center">Last Update</th>
                {% if session.role == 'admin' %}
                <th class="text-right">Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for r in rooms %}
              <tr>
                <td class="whitespace-nowrap">{{ r.room_name }}</td>
                <td class="whitespace-nowrap text-gray-400">
                  {{ r.location or '—' }}
                </td>
                <td class="text-center">{{ r.devices_count or 0 }}</td>
                <td class="text-center">{{ r.devices_with_readings or 0 }}</td>

                <td class="text-center">
                  {% if r.avg_temp is not none %} {{ '%.1f'|format(r.avg_temp)
                  }}°C {% else %}—{% endif %}
                </td>

                <td class="text-center">
                  {% if r.avg_humidity is not none %} {{
                  '%.1f'|format(r.avg_humidity) }}% {% else %}—{% endif %}
                </td>

                <td class="text-center whitespace-nowrap">
                  {% if r.last_update %} {{ (r.last_update|string).replace('T','
                  ') }} {% else %}—{% endif %}
                </td>

                {% if session.role == 'admin' %}
                <td class="text-right">
                  <form
                    action="{{ url_for('setuprooms_delete', room_id=r.id) }}"
                    method="post"
                    class="inline"
                  >
                    <button
                      type="submit"
                      class="btn btn-danger btn-sm"
                      onclick="return confirm('Delete {{ r.room_name }}?')"
                    >
                      Delete
                    </button>
                  </form>
                </td>
                {% endif %}
              </tr>

              {% else %}
              <tr>
                <td colspan="8" class="text-center text-gray-400 py-6">
                  No rooms yet — add your first one above.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Add Device Modal (Technician and Admin) -->
    {% if session.role in ['admin', 'technician'] %}
    <div
      id="addDeviceModal"
      class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50"
    >
      <div
        class="bg-gray-900 rounded-xl shadow-xl w-full max-w-lg p-6 border border-gray-700"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-200">Add Device</h3>
          <button
            id="closeAddDeviceModal"
            class="text-gray-400 hover:text-gray-200"
          >
            &times;
          </button>
        </div>

        <form
          method="post"
          action="{{ url_for('add_device') }}"
          class="space-y-4"
        >
          <div>
            <label class="form-label">Room</label>
            <select name="room_id" class="form-input" required>
              <option value="" disabled selected>Select a room</option>
              {% for r in rooms %}
              <option value="{{ r.id }}">{{ r.room_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label">Device Name</label>
            <input type="text" name="name" class="form-input" required />
          </div>

          <div>
            <label class="form-label">Device UID</label>
            <input type="text" name="device_uid" class="form-input" required />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="form-label">Type</label>
              <input type="text" name="type" class="form-input" />
            </div>
            <div>
              <label class="form-label">Status</label>
              <select name="status" class="form-input">
                <option value="active">active</option>
                <option value="inactive">inactive</option>
              </select>
            </div>
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              id="cancelAddDevice"
              class="btn bg-gray-700 hover:bg-gray-600"
            >
              Cancel
            </button>
            <button class="btn btn-primary">Save Device</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}
  </main>
</div>

<!-- Modal Script -->
<script>
  (function () {
    const open = document.getElementById("openAddDeviceModal");
    const modal = document.getElementById("addDeviceModal");
    const close = document.getElementById("closeAddDeviceModal");
    const cancel = document.getElementById("cancelAddDevice");

    function show() {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function hide() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    if (open) open.addEventListener("click", show);
    if (close) close.addEventListener("click", hide);
    if (cancel) cancel.addEventListener("click", hide);
    if (modal)
      modal.addEventListener("click", (e) => {
        if (e.target === modal) hide();
      });
  })();
</script>

{% endblock %}
