{% extends "layout.html" %}

{% block body %}
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <!-- Header -->
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2">System Setup</h1>
                        <p class="header-subtitle">
                            {% if session.role in ['admin', 'technician'] %}
                                Manage all rooms and devices system-wide.
                            {% else %}
                                Create and manage your rooms.
                            {% endif %}
                        </p>
                    </div>

                    <div class="flex items-center gap-3">
                        {% if session.role in ['admin', 'technician'] %}
                            <button id="openAddDeviceModal"
                                    class="btn bg-accent-blue hover:bg-accent-blue-hover text-white rounded flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Device
                            </button>
                        {% endif %}
                        {% include 'components/notification_bell.html' %}
                    </div>
                </div>
            </header>

            {% if session.role not in ['admin', 'technician'] and user_rooms|length == 0 and available_rooms|length == 0 %}
                <section class="mb-6">
                    <div class="card p-6 bg-accent-yellow/20 border border-accent-yellow">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-exclamation-triangle text-accent-yellow text-xl"></i>
                            <div>
                                <h4 class="text-lg font-semibold text-accent-yellow">No Rooms Available</h4>
                                <p class="text-text-secondary text-sm">
                                    There are no rooms available in the system yet. Please contact an administrator to
                                    add rooms.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            {% endif %}

            <!-- Search Bar (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
                <section class="mb-6">
                    <div class="card p-4">
                        <div class="relative">
                            <input
                                    type="text"
                                    id="roomSearchInput"
                                    placeholder="Search rooms by name, location, or devices..."
                                    class="w-full pl-10 pr-4 py-3 bg-secondary border border-border rounded-lg text-text-primary placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent-blue focus:border-transparent transition duration-200"
                            >
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-text-muted"></i>
                            </div>
                        </div>
                    </div>
                </section>
            {% endif %}

            <!-- Room Management Filters (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
                <section class="mb-6">
                    <div class="card p-4">
                        <div class="flex flex-wrap gap-2">
                            <button id="filterMyRooms"
                                    class="filter-room-btn active px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-accent-blue text-white flex items-center gap-2"
                                    data-filter="my-rooms">
                                <i class="fas fa-home"></i>
                                My Rooms ({{ user_rooms|length }})
                            </button>
                            <button id="filterAvailableRooms"
                                    class="filter-room-btn inactive px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-tertiary text-text-secondary hover:bg-tertiary-hover flex items-center gap-2"
                                    data-filter="available-rooms">
                                <i class="fas fa-door-open"></i>
                                Available Rooms ({{ available_rooms|length }})
                            </button>
                        </div>
                    </div>
                </section>
            {% endif %}

            <!-- Create Room (Technician and Admin) -->
            {% if session.role in ['admin', 'technician'] %}
                <section class="mb-6" id="createRoomSection">
                    <h3 class="text-xl font-semibold mb-4 text-text-primary flex items-center gap-2">
                        <i class="fas fa-plus-circle text-accent-green"></i>
                        Create a New Room
                    </h3>

                    <form
                            action="{{ url_for('setuprooms_create') }}"
                            method="post"
                            class="card p-4"
                    >
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div class="md:col-span-2">
                                <label for="room_name" class="form-label flex items-center gap-2">
                                    <i class="fas fa-door-closed text-text-muted"></i>
                                    Room Name
                                </label>
                                <input
                                        id="room_name"
                                        name="room_name"
                                        type="text"
                                        class="form-input"
                                        placeholder="e.g. Chemistry Lab 2"
                                        required
                                />
                            </div>

                            <div class="md:col-span-1">
                                <label for="room_location" class="form-label flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-text-muted"></i>
                                    Location (optional)
                                </label>
                                <input
                                        id="room_location"
                                        name="room_location"
                                        type="text"
                                        class="form-input"
                                        placeholder="e.g. Building B"
                                />
                            </div>

                            <div class="md:col-span-1">
                                <button type="submit"
                                        class="btn bg-accent-green hover:bg-accent-green-hover text-white w-full flex items-center justify-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    Add Room
                                </button>
                            </div>
                        </div>
                    </form>
                </section>
            {% endif %}

            <!-- My Rooms Section (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
                <section id="myRoomsSection" class="room-section">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                            <i class="fas fa-home text-accent-blue"></i>
                            My Rooms
                        </h3>
                        <span class="text-xs text-text-muted room-count flex items-center gap-1">
                            <i class="fas fa-hashtag"></i>
                            Showing <span id="myRoomsCount">{{ user_rooms|length }}</span> of {{ user_rooms|length }} room
                            {% if user_rooms|length != 1 %}s{% endif %}
                        </span>
                    </div>

                    {% if user_rooms and user_rooms|length > 0 %}
                        <div class="card p-5 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="table w-full">
                                    <thead class="bg-tertiary">
                                    <tr>
                                        <th class="text-left p-3 text-text-primary font-medium">
                                            <i class="fas fa-door-closed mr-2"></i>Room Name
                                        </th>
                                        <th class="text-left p-3 text-text-primary font-medium">
                                            <i class="fas fa-map-marker-alt mr-2"></i>Location
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-microchip mr-2"></i>Devices
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-thermometer-half mr-2"></i>Avg Temp
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-tint mr-2"></i>Avg Humidity
                                        </th>
                                        <th class="text-right p-3 text-text-primary font-medium">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="myRoomsTable">
                                    {% for r in user_rooms %}
                                        <tr class="room-row hover:bg-tertiary/40 transition border-b border-border"
                                            data-room-name="{{ r.room_name.lower() }}"
                                            data-location="{{ (r.location or '').lower() }}"
                                            data-devices="{{ r.devices_count }}">
                                            <td class="whitespace-nowrap p-3">
                                                <a href="{{ url_for('room', room_id=r.id) }}"
                                                   class="text-accent-blue hover:text-accent-blue-hover font-medium flex items-center gap-2">
                                                    <i class="fas fa-door-open"></i>
                                                    {{ r.room_name }}
                                                </a>
                                            </td>
                                            <td class="whitespace-nowrap p-3 text-text-muted">
                                                {{ r.location or '—' }}
                                            </td>
                                            <td class="text-center p-3">
                                                <span class="inline-flex items-center gap-1">
                                                    <i class="fas fa-microchip text-text-muted"></i>
                                                    {{ r.devices_count or 0 }}
                                                </span>
                                            </td>
                                            <td class="text-center p-3">
                                                {% if r.avg_temp is not none %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-thermometer-half text-accent-red"></i>
                                                        {{ '%.1f'|format(r.avg_temp) }}°C
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-center p-3">
                                                {% if r.avg_humidity is not none %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-tint text-accent-blue"></i>
                                                        {{ '%.1f'|format(r.avg_humidity) }}%
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-right p-3">
                                                <div class="flex justify-end gap-2">
                                                    <a href="{{ url_for('room', room_id=r.id) }}"
                                                       class="btn bg-accent-blue hover:bg-accent-blue-hover text-white btn-sm flex items-center gap-2">
                                                        <i class="fas fa-eye"></i>
                                                        View
                                                    </a>
                                                    <form action="{{ url_for('dashboard_remove_room', room_id=r.id) }}"
                                                          method="post"
                                                          class="inline">
                                                        <button type="submit"
                                                                class="btn bg-accent-red hover:bg-accent-red-hover text-white btn-sm flex items-center gap-2"
                                                                onclick="return confirm('Remove {{ r.room_name }} from your rooms?')">
                                                            <i class="fas fa-times"></i>
                                                            Remove
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="card p-8 text-center">
                            <i class="fas fa-inbox text-4xl text-text-muted mb-4"></i>
                            <h3 class="text-lg font-semibold text-text-primary mb-2">No Rooms Added</h3>
                            <p class="text-text-muted text-sm mb-4">
                                You haven't added any rooms to your dashboard yet.
                            </p>
                            <p class="text-text-muted text-sm flex items-center justify-center gap-2">
                                <i class="fas fa-arrow-right"></i>
                                Use the "Available Rooms" tab to find and add rooms.
                            </p>
                        </div>
                    {% endif %}
                </section>
            {% endif %}

            <!-- Available Rooms Section (Regular Users Only) -->
            {% if session.role not in ['admin', 'technician'] %}
                <section id="availableRoomsSection" class="room-section hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                            <i class="fas fa-door-open text-accent-green"></i>
                            Available Rooms
                        </h3>
                        <span class="text-xs text-text-muted room-count flex items-center gap-1">
                            <i class="fas fa-hashtag"></i>
                            Showing <span
                                id="availableRoomsCount">{{ available_rooms|length }}</span> of {{ available_rooms|length }} room
                            {% if available_rooms|length != 1 %}s{% endif %} available
                        </span>
                    </div>

                    {% if available_rooms and available_rooms|length > 0 %}
                        <div class="card p-5 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="table w-full">
                                    <thead class="bg-tertiary">
                                    <tr>
                                        <th class="text-left p-3 text-text-primary font-medium">
                                            <i class="fas fa-door-closed mr-2"></i>Room Name
                                        </th>
                                        <th class="text-left p-3 text-text-primary font-medium">
                                            <i class="fas fa-map-marker-alt mr-2"></i>Location
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-microchip mr-2"></i>Devices
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-thermometer-half mr-2"></i>Avg Temp
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-tint mr-2"></i>Avg Humidity
                                        </th>
                                        <th class="text-right p-3 text-text-primary font-medium">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="availableRoomsTable">
                                    {% for r in available_rooms %}
                                        <tr class="room-row hover:bg-tertiary/40 transition border-b border-border"
                                            data-room-name="{{ r.room_name.lower() }}"
                                            data-location="{{ (r.location or '').lower() }}"
                                            data-devices="{{ r.devices_count }}">
                                            <td class="whitespace-nowrap p-3">
                                                <a href="{{ url_for('room', room_id=r.id) }}"
                                                   class="text-accent-blue hover:text-accent-blue-hover font-medium flex items-center gap-2">
                                                    <i class="fas fa-door-open"></i>
                                                    {{ r.room_name }}
                                                </a>
                                            </td>
                                            <td class="whitespace-nowrap p-3 text-text-muted">
                                                {{ r.location or '—' }}
                                            </td>
                                            <td class="text-center p-3">
                                                <span class="inline-flex items-center gap-1">
                                                    <i class="fas fa-microchip text-text-muted"></i>
                                                    {{ r.devices_count or 0 }}
                                                </span>
                                            </td>
                                            <td class="text-center p-3">
                                                {% if r.avg_temp is not none %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-thermometer-half text-accent-red"></i>
                                                        {{ '%.1f'|format(r.avg_temp) }}°C
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-center p-3">
                                                {% if r.avg_humidity is not none %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-tint text-accent-blue"></i>
                                                        {{ '%.1f'|format(r.avg_humidity) }}%
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-right p-3">
                                                <form action="{{ url_for('dashboard_add_room', room_id=r.id) }}"
                                                      method="post"
                                                      class="inline">
                                                    <button type="submit"
                                                            class="btn bg-accent-green hover:bg-accent-green-hover text-white btn-sm flex items-center gap-2">
                                                        <i class="fas fa-plus"></i>
                                                        Add to My Rooms
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="card p-8 text-center">
                            <i class="fas fa-search text-4xl text-text-muted mb-4"></i>
                            <h3 class="text-lg font-semibold text-text-primary mb-2">No Available Rooms</h3>
                            <p class="text-text-muted text-sm">
                                There are no additional rooms available to add to your dashboard.
                            </p>
                        </div>
                    {% endif %}
                </section>
            {% endif %}

            <!-- All Rooms Section (Admin/Technician only) - NO FILTERS -->
            {% if session.role in ['admin', 'technician'] %}
                <section id="allRoomsSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                            <i class="fas fa-building text-accent-blue"></i>
                            All System Rooms
                        </h3>
                        <span class="text-xs text-text-muted room-count flex items-center gap-1">
                            <i class="fas fa-hashtag"></i>
                            {{ all_rooms|length }} room{% if all_rooms|length != 1 %}s{% endif %} total
                        </span>
                    </div>

                    {% if all_rooms and all_rooms|length > 0 %}
                        <div class="card p-5 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="table w-full">
                                    <thead class="bg-tertiary">
                                    <tr>
                                        <th class="text-left p-3 text-text-primary font-medium">
                                            <i class="fas fa-door-closed mr-2"></i>Room Name
                                        </th>
                                        <th class="text-left p-3 text-text-primary font-medium">
                                            <i class="fas fa-map-marker-alt mr-2"></i>Location
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-microchip mr-2"></i>Devices
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-chart-line mr-2"></i>With Readings
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-thermometer-half mr-2"></i>Avg Temp
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-tint mr-2"></i>Avg Humidity
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-clock mr-2"></i>Last Update
                                        </th>
                                        <th class="text-center p-3 text-text-primary font-medium">
                                            <i class="fas fa-user mr-2"></i>Owner
                                        </th>
                                        {% if session.role == 'admin' %}
                                            <th class="text-right p-3 text-text-primary font-medium">Actions</th>
                                        {% endif %}
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for r in all_rooms %}
                                        <tr class="hover:bg-tertiary/40 transition border-b border-border">
                                            <td class="whitespace-nowrap p-3">
                                                <a href="{{ url_for('room', room_id=r.id) }}"
                                                   class="text-accent-blue hover:text-accent-blue-hover font-medium flex items-center gap-2">
                                                    <i class="fas fa-door-open"></i>
                                                    {{ r.room_name }}
                                                </a>
                                            </td>
                                            <td class="whitespace-nowrap p-3 text-text-muted">
                                                {{ r.location or '—' }}
                                            </td>
                                            <td class="text-center p-3">
                                                <span class="inline-flex items-center gap-1">
                                                    <i class="fas fa-microchip text-text-muted"></i>
                                                    {{ r.devices_count or 0 }}
                                                </span>
                                            </td>
                                            <td class="text-center p-3">
                                                <span class="inline-flex items-center gap-1">
                                                    <i class="fas fa-chart-line text-accent-green"></i>
                                                    {{ r.devices_with_readings or 0 }}
                                                </span>
                                            </td>
                                            <td class="text-center p-3">
                                                {% if r.avg_temp is not none %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-thermometer-half text-accent-red"></i>
                                                        {{ '%.1f'|format(r.avg_temp) }}°C
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-center p-3">
                                                {% if r.avg_humidity is not none %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-tint text-accent-blue"></i>
                                                        {{ '%.1f'|format(r.avg_humidity) }}%
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-center p-3 whitespace-nowrap text-text-muted text-sm">
                                                {% if r.last_update %}
                                                    <span class="inline-flex items-center gap-1">
                                                        <i class="fas fa-calendar"></i>
                                                        {{ (r.last_update|string).replace('T',' ') }}
                                                    </span>
                                                {% else %}—{% endif %}
                                            </td>
                                            <td class="text-center p-3">
                                                {{ r.owner_username or '—' }}
                                            </td>
                                            {% if session.role == 'admin' %}
                                                <td class="text-right p-3">
                                                    <form
                                                            action="{{ url_for('setuprooms_delete', room_id=r.id) }}"
                                                            method="post"
                                                            class="inline"
                                                    >
                                                        <button
                                                                type="submit"
                                                                class="btn bg-accent-red hover:bg-accent-red-hover text-white btn-sm flex items-center gap-2"
                                                                onclick="return confirm('Delete {{ r.room_name }}?')"
                                                        >
                                                            <i class="fas fa-trash"></i>
                                                            Delete
                                                        </button>
                                                    </form>
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="card p-8 text-center">
                            <i class="fas fa-inbox text-4xl text-text-muted mb-4"></i>
                            <h3 class="text-lg font-semibold text-text-primary mb-2">No Rooms Found</h3>
                            <p class="text-text-muted text-sm">
                                No rooms have been created yet.
                            </p>
                        </div>
                    {% endif %}
                </section>
            {% endif %}

            <!-- Add Device Modal (Technician and Admin) -->
            {% if session.role in ['admin', 'technician'] %}
                <div
                        id="addDeviceModal"
                        class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50"
                >
                    <div
                            class="bg-secondary rounded-xl shadow-xl w-full max-w-lg p-6 border border-border"
                    >
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-text-primary flex items-center gap-2">
                                <i class="fas fa-plus-circle text-accent-blue"></i>
                                Add Device
                            </h3>
                            <button
                                    id="closeAddDeviceModal"
                                    class="text-text-muted hover:text-text-primary text-xl"
                            >
                                &times;
                            </button>
                        </div>

                        <form
                                method="post"
                                action="{{ url_for('add_device') }}"
                                class="space-y-4"
                        >
                            <div>
                                <label class="form-label flex items-center gap-2">
                                    <i class="fas fa-door-open text-text-muted"></i>
                                    Room
                                </label>
                                <select name="room_id" class="form-input" required>
                                    <option value="" disabled selected>Select a room</option>
                                    {% for r in all_rooms %}
                                        <option value="{{ r.id }}">{{ r.room_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="form-label flex items-center gap-2">
                                    <i class="fas fa-tag text-text-muted"></i>
                                    Device Name
                                </label>
                                <input type="text" name="name" class="form-input" required/>
                            </div>

                            <div>
                                <label class="form-label flex items-center gap-2">
                                    <i class="fas fa-fingerprint text-text-muted"></i>
                                    Device UID
                                </label>
                                <input type="text" name="device_uid" class="form-input" required/>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="form-label flex items-center gap-2">
                                        <i class="fas fa-cog text-text-muted"></i>
                                        Type
                                    </label>
                                    <input type="text" name="type" class="form-input" placeholder="e.g., Sensor"/>
                                </div>
                                <div>
                                    <label class="form-label flex items-center gap-2">
                                        <i class="fas fa-circle text-text-muted"></i>
                                        Status
                                    </label>
                                    <select name="status" class="form-input">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex justify-end gap-2 pt-2">
                                <button
                                        type="button"
                                        id="cancelAddDevice"
                                        class="btn bg-tertiary hover:bg-tertiary-hover text-text-primary flex items-center gap-2"
                                >
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button class="btn bg-accent-blue hover:bg-accent-blue-hover text-white flex items-center gap-2">
                                    <i class="fas fa-save"></i>
                                    Save Device
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>

    <!-- Search Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Only initialize for regular users
            {% if session.role not in ['admin', 'technician'] %}
                console.log('Initializing setup page for regular user');

                const filterButtons = document.querySelectorAll('.filter-room-btn');
                const roomSections = document.querySelectorAll('.room-section');
                const searchInput = document.getElementById('roomSearchInput');

                function showSection(sectionType) {
                    console.log('Switching to section type:', sectionType);

                    const sectionId = sectionType === 'my-rooms' ? 'myRoomsSection' : 'availableRoomsSection';
                    const targetSection = document.getElementById(sectionId);

                    // Hide all room sections
                    roomSections.forEach(section => {
                        section.classList.add('hidden');
                    });

                    // Show selected section
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                        console.log('Section displayed:', targetSection.id);
                        updateRoomCount(targetSection);
                    }

                    // Update button states
                    filterButtons.forEach(btn => {
                        if (btn.dataset.filter === sectionType) {
                            btn.classList.remove('inactive', 'bg-tertiary', 'text-text-secondary');
                            btn.classList.add('active', 'bg-accent-blue', 'text-white');
                        } else {
                            btn.classList.remove('active', 'bg-accent-blue', 'text-white');
                            btn.classList.add('inactive', 'bg-tertiary', 'text-text-secondary');
                        }
                    });

                    // Apply search filter
                    if (searchInput && searchInput.value.trim()) {
                        filterRooms(searchInput.value.trim());
                    }
                }

                function updateRoomCount(section) {
                    const rows = section.querySelectorAll('.room-row');
                    const visibleRows = Array.from(rows).filter(row => !row.classList.contains('hidden'));
                    const countElement = section.querySelector('.room-count span');

                    console.log(`Updating count: ${visibleRows.length} visible rows`);

                    if (countElement) {
                        countElement.textContent = visibleRows.length;
                    }
                }

                function filterRooms(searchTerm) {
                    const activeSection = document.querySelector('.room-section:not(.hidden)');
                    if (!activeSection) {
                        console.log('No active section found');
                        return;
                    }

                    console.log(`Filtering rooms with: "${searchTerm}"`);
                    const rows = activeSection.querySelectorAll('.room-row');
                    console.log(`Total rows to filter: ${rows.length}`);

                    let visibleCount = 0;

                    rows.forEach((row, index) => {
                        const roomName = row.dataset.roomName || '';
                        const location = row.dataset.location || '';
                        const devices = row.dataset.devices || '';

                        console.log(`Row ${index}:`, {roomName, location, devices});

                        const searchLower = searchTerm.toLowerCase();
                        const matches = !searchTerm ||
                            roomName.includes(searchLower) ||
                            location.includes(searchLower) ||
                            devices.includes(searchLower);

                        console.log(`Row ${index} matches:`, matches);

                        if (matches) {
                            row.classList.remove('hidden');
                            visibleCount++;
                        } else {
                            row.classList.add('hidden');
                        }
                    });

                    updateRoomCount(activeSection);
                    console.log(`Filter complete: ${visibleCount} rooms match "${searchTerm}"`);
                }

                // Add event listeners
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const filterType = this.getAttribute('data-filter');
                        showSection(filterType);
                    });
                });

                if (searchInput) {
                    searchInput.addEventListener('input', function () {
                        const searchTerm = this.value.trim();
                        console.log('Search input:', searchTerm);
                        if (searchTerm) {
                            filterRooms(searchTerm);
                        } else {
                            // Clear search - show all rows
                            const activeSection = document.querySelector('.room-section:not(.hidden)');
                            if (activeSection) {
                                const rows = activeSection.querySelectorAll('.room-row');
                                rows.forEach(row => row.classList.remove('hidden'));
                                updateRoomCount(activeSection);
                            }
                        }
                    });
                }

                // Initialize
                showSection('my-rooms');
            {% endif %}
        });
    </script>
    <!-- Modal Script -->
    <script>
        (function () {
            const open = document.getElementById("openAddDeviceModal");
            const modal = document.getElementById("addDeviceModal");
            const close = document.getElementById("closeAddDeviceModal");
            const cancel = document.getElementById("cancelAddDevice");

            function show() {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
            }

            function hide() {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            if (open) open.addEventListener("click", show);
            if (close) close.addEventListener("click", hide);
            if (cancel) cancel.addEventListener("click", hide);
            if (modal)
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) hide();
                });
        })();
    </script>

    <style>
        /* Ensure tables are always visible */
        .room-section table {
            display: table !important;
            width: 100% !important;
        }

        .room-section tbody {
            display: table-row-group !important;
        }

        .room-section tr {
            display: table-row !important;
        }

        .room-section td, .room-section th {
            display: table-cell !important;
        }

        /* Override any hiding that might be happening */
        .room-section .room-row {
            display: table-row !important;
        }

        /* Fix for search functionality - properly hide table rows */
        .room-section .room-row.hidden {
            display: none !important;
        }

        .table th {
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .table td {
            border-bottom: 1px solid var(--border-color);
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
    </style>{% endblock %}