{% extends "layout.html" %}

{% block body %}
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    <div class="app-container">
        {% include 'components/menu.html' %}

        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-extrabold text-text-primary mb-2">Facilities Dashboard</h1>
                        <p class="header-subtitle">
                            {% if session.role in ['admin', 'technician'] %}
                                Complete system-wide overview of all rooms and sensor data.
                            {% else %}
                                Overview of your assigned rooms and devices.
                                <span class="ml-2 inline-block px-2 py-0.5 rounded bg-accent-blue text-white text-xs align-middle">
                                   Your readings only
                               </span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        {% if session.get('role') in ['admin', 'technician'] %}
                            <div class="flex items-center gap-2">
                                <button onclick="previewSensorLogs()"
                                        class="btn p-2 bg-tertiary hover:bg-tertiary-hover text-text-secondary text-sm flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Sensor Logs
                                </button>
                                <button onclick="previewRoomsJSON()"
                                        class="btn p-2 bg-tertiary hover:bg-tertiary-hover text-text-secondary text-sm flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Rooms JSON
                                </button>
                                <button onclick="previewReadingsJSON()"
                                        class="btn p-2 bg-tertiary hover:bg-tertiary-hover text-text-secondary text-sm flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Readings JSON
                                </button>
                            </div>
                        {% endif %}
                        {% include 'components/notification_bell.html' %}
                    </div>
                </div>
            </header>

            <div id="dataPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                <div class="bg-secondary rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                    <div class="flex items-center justify-between p-6 border-b border-border">
                        <h3 id="modalTitle" class="text-xl font-bold text-text-primary">Data Preview</h3>
                        <div class="flex items-center gap-2">
                            <button id="downloadBtn" class="btn bg-accent-blue hover:bg-accent-blue-hover text-white text-sm py-2 px-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Download
                            </button>
                            <button onclick="closePreviewModal()" class="bg-tertiary hover:bg-tertiary-hover text-text-primary text-sm py-2 px-4 rounded-lg">
                                Close
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div id="modalContent" class="h-full overflow-auto p-6">
                            <div class="text-center text-text-muted py-8">
                                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p>Loading preview...</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-border bg-tertiary text-sm text-text-muted flex justify-between items-center">
                        <span id="dataStats">Preparing data...</span>
                        <span id="fileInfo"></span>
                    </div>
                </div>
            </div>

            {% include 'components/search_bar.html' %}

            {% if rooms and rooms|length > 0 %}
                <section class="mt-4" id="roomsSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-text-secondary">
                            {% if session.role in ['admin', 'technician'] %}
                                All System Rooms
                            {% else %}
                                Your Rooms
                            {% endif %}
                        </h3>
                        <span class="text-xs text-text-muted room-count">
                            {{ rooms|length }} room{% if rooms|length != 1 %}s{% endif %}
                            {% if session.role in ['admin', 'technician'] %} system-wide{% endif %}
                        </span>
                    </div>

                    <div class="grid-cards" id="roomsGrid">
                        {% for r in rooms %}
                            <a href="{{ url_for('room', room_id=r.id) }}"
                               class="card hover:ring-2 hover:ring-accent-blue/50 transition duration-150 ease-in-out room-card"
                               data-room-name="{{ r.room_name.lower() }}"
                               data-location="{{ (r.location or '').lower() }}"
                               data-devices="{{ r.devices_count }}"
                               data-temp="{{ r.avg_temp or '' }}"
                               data-humidity="{{ r.avg_humidity or '' }}"
                               {% if session.role in ['admin', 'technician'] %}data-owner="{{ (r.owner_username or '').lower() }}"{% endif %}
                            >
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h4 class="text-xl font-bold text-text-primary mb-1 room-name">
                                            {{ r.room_name }}
                                        </h4>
                                        <p class="text-sm text-text-muted flex items-center gap-1 room-location">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                      d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            {{ r.location or 'Unspecified location' }}
                                        </p>
                                        {% if session.role in ['admin', 'technician'] and r.owner_username %}
                                            <p class="text-xs text-text-muted flex items-center gap-1 mt-1 room-owner">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                     viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          stroke-width="2"
                                                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                                Owner: {{ r.owner_username }}
                                            </p>
                                        {% endif %}
                                    </div>

                                    {% set status_label = "Normal" %}
                                    {% set status_class = "bg-accent-green/20 text-accent-green" %}
                                    {% if r.avg_temp and (r.avg_temp > 24 or r.avg_temp < 18) %}
                                        {% set status_label = "Warning" %}
                                        {% set status_class = "bg-accent-yellow/20 text-accent-yellow" %}
                                    {% endif %}
                                    {% if r.avg_temp and (r.avg_temp > 26 or r.avg_temp < 16) %}
                                        {% set status_label = "Critical" %}
                                        {% set status_class = "bg-accent-red/20 text-accent-red" %}
                                    {% endif %}

                                    <span class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full {{ status_class }}">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                        </svg>
                                        {{ status_label }}
                                    </span>
                                </div>

                                <div class="mt-4 grid grid-cols-3 gap-4 border-t border-border pt-3">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M17 20h5v-3m-1.5-1.5l-4-4m4 4H18m2.5 0v5"></path>
                                        </svg>
                                        <div>
                                            <div class="text-xs text-text-muted">Temp</div>
                                            <div class="text-lg font-semibold text-text-primary room-temp">
                                                {% if r.avg_temp is not none %}{{ r.avg_temp }}°C{% else %}—{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M12 6.5v12m-6-6h12"></path>
                                        </svg>
                                        <div>
                                            <div class="text-xs text-text-muted">Humidity</div>
                                            <div class="text-lg font-semibold text-text-primary room-humidity">
                                                {% if r.avg_humidity is not none %}{{ r.avg_humidity }}%{% else %}
                                                    —{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M12 4.5V1m0 3v20m0-12h12m-12 0H1"></path>
                                        </svg>
                                        <div>
                                            <div class="text-xs text-text-muted">Devices</div>
                                            <div class="text-lg font-semibold text-text-primary room-devices">
                                                {{ r.devices_count or 0 }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            {% if rows and rows|length > 0 %}
                <section class="mt-8" id="readingsSection">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-text-secondary">
                            {% if session.role in ['admin', 'technician'] %}
                                All Recent Sensor Readings
                            {% else %}
                                Your Recent Readings
                            {% endif %}
                        </h3>
                        <span class="text-xs text-text-muted readings-count">
                            {{ rows|length }} reading{% if rows|length != 1 %}s{% endif %}
                            {% if session.role in ['admin', 'technician'] %} system-wide{% endif %}
                        </span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-border text-text-secondary bg-secondary">
                            <thead class="bg-tertiary">
                            <tr>
                                <th class="p-2 text-left">Device</th>
                                <th class="p-2 text-left">UID</th>
                                <th class="p-2 text-left">Type</th>
                                {% if session.role in ['admin', 'technician'] %}
                                    <th class="p-2 text-left">Room</th>
                                    <th class="p-2 text-left">Owner</th>
                                {% endif %}
                                <th class="p-2 text-left">Temp (°C)</th>
                                <th class="p-2 text-left">Humidity (%)</th>
                                <th class="p-2 text-left">Motion</th>
                                <th class="p-2 text-left">Recorded</th>
                            </tr>
                            </thead>
                            <tbody id="readingsTable">
                            {% for r in rows %}
                                <tr class="hover:bg-tertiary/40 transition reading-row"
                                    data-device-name="{{ (r.device_name or 'N/A').lower() }}"
                                    data-device-uid="{{ (r.device_uid or '').lower() }}"
                                    data-device-type="{{ ((r.device_type if r.device_type is defined else r.type) or '').lower() }}"
                                    data-temp="{{ r.temperature or '' }}"
                                    data-humidity="{{ r.humidity or '' }}"
                                    data-motion="{{ r.motion_detected or '' }}"
                                        {% if session.role in ['admin', 'technician'] %}
                                    data-room-name="{{ (r.room_name or '').lower() }}"
                                    data-owner="{{ (r.room_owner or '').lower() }}"
                                        {% endif %}
                                >
                                    <td class="p-2 reading-device text-text-primary">{{ r.device_name or 'N/A' }}</td>
                                    <td class="p-2 text-text-muted reading-uid">{{ r.device_uid or '—' }}</td>
                                    <td class="p-2 reading-type text-text-secondary">
                                        {{ r.device_type if r.device_type is defined else (r.type or '—') }}
                                    </td>
                                    {% if session.role in ['admin', 'technician'] %}
                                        <td class="p-2 reading-room">
                                            <a href="{{ url_for('room', room_id=r.room_id) }}"
                                               class="text-accent-blue hover:text-accent-blue-hover">
                                                {{ r.room_name or '—' }}
                                            </a>
                                        </td>
                                        <td class="p-2 reading-owner text-text-secondary">{{ r.room_owner or '—' }}</td>
                                    {% endif %}
                                    <td class="p-2 reading-temp text-text-secondary">{{ r.temperature if r.temperature is not none else '—' }}</td>
                                    <td class="p-2 reading-humidity text-text-secondary">{{ r.humidity if r.humidity is not none else '—' }}</td>
                                    <td class="p-2 reading-motion">
                                        {% if r.motion_detected == 1 %}
                                            <span class="text-accent-green font-semibold">Yes</span>
                                        {% elif r.motion_detected == 0 %}
                                            <span class="text-accent-red">No</span>
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="p-2 whitespace-nowrap reading-time text-text-muted">
                                        {% if r.recorded_at %}{{ (r.recorded_at|string).replace('T',' ') }}{% else %}
                                            —{% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>
            {% endif %}

            <div id="noResults" class="hidden">
                <div class="card text-center py-12">
                    <svg class="w-16 h-16 text-text-muted mx-auto mb-4" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-text-primary mb-2">No results found</h3>
                    <p class="text-text-muted text-sm">
                        Try adjusting your search terms or filters to find what you're looking for.
                    </p>
                </div>
            </div>

            {% if (not rooms or rooms|length == 0) and (not rows or rows|length == 0) %}
                <section class="mt-4">
                    <div class="grid-cards">
                        <div class="card">
                            <h4 class="text-lg font-bold text-text-primary mb-2">No Data Found</h4>
                            <p class="text-sm text-text-muted mb-4">
                                {% if session.role in ['admin', 'technician'] %}
                                    No rooms or sensor readings found in the system.
                                {% else %}
                                    No rooms have been added to your dashboard yet.
                                {% endif %}
                            </p>
                            {% if session.role not in ['admin', 'technician'] %}
                                <a href="{{ url_for('setup') }}" class="btn btn-primary">
                                    Go to Setup to Add Rooms
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </section>
            {% endif %}
        </main>
    </div>

    <script>
        let currentPreviewData = null;
        let currentPreviewType = null;
        let currentPreviewFilename = null;

        function previewSensorLogs() {
            showLoadingPreview();
            currentPreviewType = 'sensor_logs';
            currentPreviewFilename = 'sensor_logs.csv';

            const rows = document.querySelectorAll('.reading-row');
            let csvContent = 'Device Name,Device UID,Device Type,Room,Owner,Temperature (°C),Humidity (%),Motion,Recorded At\n';

            rows.forEach(function (row) {
                const device = row.querySelector('.reading-device').textContent;
                const uid = row.querySelector('.reading-uid').textContent;
                const type = row.querySelector('.reading-type').textContent;
                const room = row.querySelector('.reading-room') ? row.querySelector('.reading-room').textContent.trim() : '—';
                const owner = row.querySelector('.reading-owner') ? row.querySelector('.reading-owner').textContent : '—';
                const temp = row.querySelector('.reading-temp').textContent;
                const humidity = row.querySelector('.reading-humidity').textContent;
                const motion = row.querySelector('.reading-motion').textContent;
                const time = row.querySelector('.reading-time').textContent;

                csvContent += '"' + device + '","' + uid + '","' + type + '","' + room + '","' +
                    owner + '","' + temp + '","' + humidity + '","' + motion + '","' + time + '"\n';
            });

            currentPreviewData = csvContent;
            showPreviewModal('Sensor Logs Preview', formatCSVPreview(csvContent), 'CSV', rows.length);
        }

        function previewRoomsJSON() {
            showLoadingPreview();
            currentPreviewType = 'rooms_json';
            currentPreviewFilename = 'rooms_data.json';

            fetch('/api/rooms')
                .then(function (response) { return response.json(); })
                .then(function (data) {
                    const jsonContent = JSON.stringify(data, null, 2);
                    currentPreviewData = jsonContent;
                    showPreviewModal('Rooms Data Preview', formatJSONPreview(jsonContent), 'JSON', data.length);
                })
                .catch(function (error) {
                    console.error('Error fetching rooms JSON:', error);
                    showPreviewError('Failed to load rooms data. Please try again.');
                });
        }

        function previewReadingsJSON() {
            showLoadingPreview();
            currentPreviewType = 'readings_json';
            currentPreviewFilename = 'readings_data.json';

            fetch('/api/readings?limit=1000')
                .then(function (response) { return response.json(); })
                .then(function (data) {
                    const jsonContent = JSON.stringify(data, null, 2);
                    currentPreviewData = jsonContent;
                    showPreviewModal('Readings Data Preview', formatJSONPreview(jsonContent), 'JSON', data.length);
                })
                .catch(function (error) {
                    console.error('Error fetching readings JSON:', error);
                    showPreviewError('Failed to load readings data. Please try again.');
                });
        }

        function showPreviewModal(title, content, format, recordCount) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('dataStats').textContent = recordCount + ' records • ' + format + ' format';
            document.getElementById('fileInfo').textContent = 'File: ' + currentPreviewFilename;

            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.onclick = downloadCurrentPreview;
            downloadBtn.innerHTML =
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                          'd="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>' +
                '</svg>' +
                '<span class="ml-1">Download ' + currentPreviewFilename + '</span>';

            document.getElementById('dataPreviewModal').classList.remove('hidden');
        }

        function showLoadingPreview() {
            document.getElementById('modalContent').innerHTML =
                '<div class="text-center text-text-muted py-8">' +
                    '<svg class="w-12 h-12 mx-auto mb-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                              'd="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                    '</svg>' +
                    '<p>Loading data preview...</p>' +
                '</div>';
            document.getElementById('dataPreviewModal').classList.remove('hidden');
        }

        function showPreviewError(message) {
            document.getElementById('modalContent').innerHTML =
                '<div class="text-center text-accent-red py-8">' +
                    '<svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                              'd="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                    '</svg>' +
                    '<p class="text-lg font-semibold mb-2">Error</p>' +
                    '<p>' + message + '</p>' +
                '</div>';
            document.getElementById('downloadBtn').style.display = 'none';
        }

        function formatCSVPreview(csvContent) {
            const lines = csvContent.split('\n').slice(0, 101);
            const isTruncated = lines.length > 100;
            const displayLines = isTruncated ? lines.slice(0, 100) : lines;

            let html = '' +
                '<div class="mb-4 p-3 bg-tertiary rounded-lg">' +
                    '<div class="flex items-center gap-2 text-sm text-text-muted">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                                  'd="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                        '</svg>' +
                        '<span>Preview showing ' + (displayLines.length - 1) + ' records' +
                        (isTruncated ? ' (first 100)' : '') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="bg-primary border border-border rounded-lg overflow-hidden">' +
                    '<pre class="text-sm p-4 overflow-auto max-h-96">' + displayLines.join('\n') + '</pre>' +
                '</div>';

            if (isTruncated) {
                html += '' +
                    '<div class="mt-3 p-3 bg-accent-yellow/20 border border-accent-yellow/30 rounded-lg">' +
                        '<div class="flex items-center gap-2 text-accent-yellow text-sm">' +
                            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                                      'd="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>' +
                            '</svg>' +
                            '<span>Preview truncated. Full download will include all ' + (lines.length - 1) + ' records.</span>' +
                        '</div>' +
                    '</div>';
            }

            return html;
        }

        function formatJSONPreview(jsonContent) {
            const data = JSON.parse(jsonContent);
            const previewData = data.slice(0, 10);
            const isTruncated = data.length > 10;

            let html = '' +
                '<div class="mb-4 p-3 bg-tertiary rounded-lg">' +
                    '<div class="flex items-center gap-2 text-sm text-text-muted">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                                  'd="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                        '</svg>' +
                        '<span>Preview showing ' + previewData.length + ' records' +
                        (isTruncated ? ' (first 10)' : '') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="bg-primary border border-border rounded-lg overflow-hidden">' +
                    '<pre class="text-sm p-4 overflow-auto max-h-96">' +
                        JSON.stringify(previewData, null, 2) +
                    '</pre>' +
                '</div>';

            if (isTruncated) {
                html += '' +
                    '<div class="mt-3 p-3 bg-accent-yellow/20 border border-accent-yellow/30 rounded-lg">' +
                        '<div class="flex items-center gap-2 text-accent-yellow text-sm">' +
                            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                                      'd="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>' +
                            '</svg>' +
                            '<span>Preview truncated. Full download will include all ' + data.length + ' records.</span>' +
                        '</div>' +
                    '</div>';
            }

            return html;
        }

        function downloadCurrentPreview() {
            if (!currentPreviewData) return;

            const contentType = currentPreviewType.indexOf('json') !== -1 ? 'application/json' : 'text/csv';
            downloadFile(currentPreviewData, currentPreviewFilename, contentType);
            closePreviewModal();
            showDownloadFeedback(currentPreviewFilename + ' downloaded successfully', 'success');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function closePreviewModal() {
            document.getElementById('dataPreviewModal').classList.add('hidden');
            currentPreviewData = null;
            currentPreviewType = null;
            currentPreviewFilename = null;
            document.getElementById('downloadBtn').style.display = 'flex';
        }

        function showDownloadFeedback(message, type) {
            if (!type) type = 'info';
            const feedback = document.createElement('div');
            let className = 'fixed top-4 right-4 p-3 rounded-lg shadow-lg z-50 ';

            if (type === 'success') {
                className += 'bg-green-600 text-white';
            } else if (type === 'error') {
                className += 'bg-red-600 text-white';
            } else {
                className += 'bg-blue-600 text-white';
            }

            feedback.className = className;
            feedback.innerHTML =
                '<div class="flex items-center gap-2">' +
                    '<span class="text-sm">' + message + '</span>' +
                    '<button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
                                  'd="M6 18L18 6M6 6l12 12"></path>' +
                        '</svg>' +
                    '</button>' +
                '</div>';

            document.body.appendChild(feedback);

            setTimeout(function () {
                if (feedback.parentElement) {
                    feedback.remove();
                }
            }, 5000);
        }

        document.getElementById('dataPreviewModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closePreviewModal();
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closePreviewModal();
            }
        });
    </script>

    <script>
        console.log('Debug: Page loaded');
        console.log('User role:', '{{ session.role }}');

        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            const searchResults = document.getElementById('searchResults');
            const resultsCount = document.getElementById('resultsCount');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const statusFilter = document.getElementById('statusFilter');
            const roomsSection = document.getElementById('roomsSection');
            const readingsSection = document.getElementById('readingsSection');
            const noResults = document.getElementById('noResults');

            let currentFilter = 'rooms';
            let currentStatusFilter = 'all';

            const isAdminOrTechnician = '{{ session.role }}' === 'admin' || '{{ session.role }}' === 'technician';

            function getRoomStatus(roomCard) {
                const statusBadge = roomCard.querySelector('.inline-flex.items-center');
                if (statusBadge) {
                    const statusText = statusBadge.textContent.trim().toLowerCase();
                    if (statusText.indexOf('normal') !== -1) return 'normal';
                    if (statusText.indexOf('warning') !== -1) return 'warning';
                    if (statusText.indexOf('critical') !== -1) return 'critical';
                }
                return 'no-data';
            }

            function updateVisibility() {
                const searchTerm = (searchInput ? searchInput.value : '').toLowerCase();
                let totalVisible = 0;

                if (roomsSection) {
                    const roomCards = roomsSection.querySelectorAll('.room-card');
                    let visibleRooms = 0;

                    roomCards.forEach(function (card) {
                        const roomName = card.dataset.roomName || '';
                        const location = card.dataset.location || '';
                        const devices = card.dataset.devices || '';
                        const temp = card.dataset.temp || '';
                        const humidity = card.dataset.humidity || '';
                        const owner = card.dataset.owner || '';

                        const matchesSearch = !searchTerm ||
                            roomName.indexOf(searchTerm) !== -1 ||
                            location.indexOf(searchTerm) !== -1 ||
                            devices.indexOf(searchTerm) !== -1 ||
                            temp.indexOf(searchTerm) !== -1 ||
                            humidity.indexOf(searchTerm) !== -1 ||
                            (isAdminOrTechnician && owner.indexOf(searchTerm) !== -1);

                        let matchesStatus = true;
                        if (isAdminOrTechnician && currentStatusFilter !== 'all') {
                            const roomStatus = getRoomStatus(card);
                            matchesStatus = roomStatus === currentStatusFilter;
                        }

                        if (matchesSearch && matchesStatus && (currentFilter === 'rooms' || currentFilter === 'all')) {
                            card.style.display = 'block';
                            visibleRooms++;
                            totalVisible++;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    const roomCount = document.querySelector('.room-count');
                    if (roomCount) {
                        const totalRooms = roomsSection.querySelectorAll('.room-card').length;
                        const displayText = (searchTerm || (isAdminOrTechnician && currentStatusFilter !== 'all')) ?
                            (visibleRooms + '/' + totalRooms + ' rooms') :
                            (totalRooms + ' room' + (totalRooms !== 1 ? 's' : ''));
                        roomCount.textContent = displayText;
                    }
                }

                if (readingsSection) {
                    const readingRows = readingsSection.querySelectorAll('.reading-row');
                    let visibleReadings = 0;

                    readingRows.forEach(function (row) {
                        const deviceName = row.dataset.deviceName || '';
                        const deviceUid = row.dataset.deviceUid || '';
                        const deviceType = row.dataset.deviceType || '';
                        const temp = row.dataset.temp || '';
                        const humidity = row.dataset.humidity || '';
                        const motion = row.dataset.motion || '';
                        const roomName = row.dataset.roomName || '';
                        const owner = row.dataset.owner || '';

                        const matchesSearch = !searchTerm ||
                            deviceName.indexOf(searchTerm) !== -1 ||
                            deviceUid.indexOf(searchTerm) !== -1 ||
                            deviceType.indexOf(searchTerm) !== -1 ||
                            temp.indexOf(searchTerm) !== -1 ||
                            humidity.indexOf(searchTerm) !== -1 ||
                            motion.indexOf(searchTerm) !== -1 ||
                            (isAdminOrTechnician && roomName.indexOf(searchTerm) !== -1) ||
                            (isAdminOrTechnician && owner.indexOf(searchTerm) !== -1);

                        if (matchesSearch && (currentFilter === 'readings' || currentFilter === 'all')) {
                            row.style.display = '';
                            visibleReadings++;
                            totalVisible++;
                        } else {
                            row.style.display = 'none';
                        }
                    });

                    const readingsCount = document.querySelector('.readings-count');
                    if (readingsCount) {
                        const totalReadings = readingsSection.querySelectorAll('.reading-row').length;
                        const displayText = searchTerm ?
                            (visibleReadings + '/' + totalReadings + ' readings') :
                            (totalReadings + ' reading' + (totalReadings !== 1 ? 's' : ''));
                        readingsCount.textContent = displayText;
                    }
                }

                if (totalVisible === 0 && (searchTerm || (isAdminOrTechnician && currentStatusFilter !== 'all'))) {
                    noResults.classList.remove('hidden');
                    if (roomsSection) roomsSection.style.display = 'none';
                    if (readingsSection) readingsSection.style.display = 'none';
                } else {
                    noResults.classList.add('hidden');
                    if (roomsSection && roomsSection.querySelectorAll('.room-card').length > 0) {
                        roomsSection.style.display = '';
                    }
                    if (readingsSection && readingsSection.querySelectorAll('.reading-row').length > 0) {
                        readingsSection.style.display = '';
                    }
                }

                if (searchTerm || (isAdminOrTechnician && currentStatusFilter !== 'all')) {
                    if (searchResults) {
                        searchResults.classList.remove('hidden');
                        resultsCount.textContent = totalVisible;
                    }
                } else if (searchResults) {
                    searchResults.classList.add('hidden');
                }

                if (clearSearch) {
                    if (searchTerm) {
                        clearSearch.classList.remove('hidden');
                    } else {
                        clearSearch.classList.add('hidden');
                    }
                }
            }

            if (searchInput) {
                searchInput.addEventListener('input', updateVisibility);
            }

            if (clearSearch) {
                clearSearch.addEventListener('click', function () {
                    searchInput.value = '';
                    if (statusFilter) statusFilter.value = 'all';
                    currentStatusFilter = 'all';
                    updateVisibility();
                    searchInput.focus();
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', function () {
                    currentStatusFilter = this.value;
                    updateVisibility();
                });
            }

            filterButtons.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    currentFilter = this.dataset.filter;

                    filterButtons.forEach(function (b) {
                        if (b === btn) {
                            b.classList.remove('inactive', 'bg-gray-600', 'text-gray-300');
                            b.classList.add('active', 'bg-blue-600', 'text-white');
                        } else {
                            b.classList.remove('active', 'bg-blue-600', 'text-white');
                            b.classList.add('inactive', 'bg-gray-600', 'text-gray-300');
                        }
                    });

                    updateVisibility();
                });
            });

            updateVisibility();

            console.log('Search and filter system initialized');
            console.log('Admin/Technician mode:', isAdminOrTechnician);
        });
    </script>
{% endblock %}
