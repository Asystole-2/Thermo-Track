<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thermo-Track</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        /* General styling for the dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background matching the dashboard */
            color: #ffffff;
        }
        /* Style for Flash Messages */
        .flash {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeout 5s forwards; /* Added animation for auto-hide */
        }
        .flash.success {
            background-color: #10b981; /* Emerald green */
        }
        .flash.error {
            background-color: #ef4444; /* Red */
        }
        .flash.warning {
            background-color: #f59e0b; /* Amber */
        }

        @keyframes fadeout {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
    </style>
  </head>
  <body>
    <!-- Main content block defined by child templates -->
    {% block body %}
    {% endblock %}

    <!-- Flash Messages Display -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, msg in messages %}
            <!-- category will be success, error, or warning -->
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
 <!-- Flash messages ... -->

<script>
(function () {
  //Step 1 â€” recognizer factory and engines
  function WebSpeechRecognizer(lang = 'en-IE') {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) throw new Error('Web Speech API not supported');

    const r = new SR();
    r.lang = lang;
    r.interimResults = false;
    r.maxAlternatives = 1;

    return {
      start(onText, onState) {
        r.onstart = () => onState?.('listening');
        r.onend   = () => onState?.('idle');
        r.onerror = e => onState?.('error:' + e.error);
        r.onresult = e => {
          const text = e.results[0][0].transcript.trim();
          onText(text);
        };
        r.start();
      }
    };
  }

  // Step 2 â€” create recognizer (pluggable)
  function createRecognizer() {
    try {
      return WebSpeechRecognizer('en-IE'); // default engine
    } catch (err) {
      console.warn('Voice engine unavailable:', err.message);
      return null;
    }
  }

  // Step 3 â€” apply to your Thermo-Track voiceable fields
  const asr = createRecognizer();
  if (!asr) return; // no mic support

  window.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.tt_voiceable').forEach(input => {
      const type = (input.type || '').toLowerCase();
      if (type === 'password') return;

      // wrap + mic button
      const wrap = document.createElement('div');
      wrap.className = 'flex items-center gap-2';
      input.parentNode.insertBefore(wrap, input);
      wrap.appendChild(input);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'ðŸŽ¤';
      btn.className =
        'tt_micButton px-3 py-2 rounded-md bg-slate-700 text-white border border-slate-600 hover:bg-slate-600';
      wrap.appendChild(btn);

      const status = document.createElement('span');
      status.className = 'text-xs opacity-70';
      wrap.appendChild(status);

      const mode = (input.dataset.voiceMode || 'replace').toLowerCase();

      btn.addEventListener('click', () => {
        if (!asr) return;
        input.focus();
        asr.start(
          text => {
            if (mode === 'append' && input.value) {
              input.value = input.value.replace(/\s*$/, '') + ' ' + text;
            } else {
              input.value = text;
            }
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            status.textContent = 'Heard: ' + text;
            setTimeout(() => (status.textContent = ''), 2500);
          },
          state => {
            if (state === 'listening') status.textContent = 'Listeningâ€¦';
            else if (state.startsWith('error')) status.textContent = 'Mic error';
            else status.textContent = '';
          }
        );
      });
    });
  });
})();
</script>
</body>
</html>

