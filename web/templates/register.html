{% extends "layout.html" %}

{% block body %}
<div class="flex items-center justify-center min-h-screen bg-gray-900">
  <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-xl shadow-2xl">
    <h2 class="text-2xl font-bold text-center text-white">Create an Account</h2>

    {# Only show success flashes; field errors render inline #}
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        {% for category, message in msgs %}
          {% if category == 'success' %}
            <div class="p-3 text-center rounded-md bg-green-600 text-white">{{ message }}</div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}

    {# Ensure templates always have dicts available #}
    {% set errors = errors|default({}) %}
    {% set values = values|default({}) %}

    <form id="registerForm" action="{{ url_for('register') }}" method="post" class="space-y-4" novalidate>
      <!-- Username -->
      <div>
        <input
          id="username"
          name="username"
          type="text"
          autocomplete="off"
          placeholder="Username"
          required
          value="{{ values.get('username','') }}"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2"
        />
        <p id="usernameError"
           class="text-red-400 text-sm mt-1 {{ '' if errors.get('username') else 'hidden' }}">
          {{ errors.get('username','') }}
        </p>
      </div>

      <!-- Email -->
      <div>
        <input
          id="email"
          name="email"
          type="text"  {# we validate ourselves #}
          autocomplete="off"
          placeholder="Email Address"
          required
          value="{{ values.get('email','') }}"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2"
        />
        <p id="emailError"
           class="text-red-400 text-sm mt-1 {{ '' if errors.get('email') else 'hidden' }}">
          {{ errors.get('email','') }}
        </p>
      </div>

      <!-- Password -->
      <div>
        <input
          id="password"
          type="password"
          name="password"
          placeholder="Password"
          required
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2"
        />
        <p class="text-sm text-gray-400 mt-1">
          ≥ 8 characters, one uppercase, one number, one symbol.
        </p>
        <p id="passwordError"
           class="text-red-400 text-sm mt-1 {{ '' if errors.get('password') else 'hidden' }}">
          {{ errors.get('password','') }}
        </p>
      </div>

      <!-- Confirm Password -->
      <div>
        <input
          id="confirmation"
          type="password"
          name="confirmation"
          placeholder="Confirm Password"
          required
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2"
        />
        <p id="confirmError"
           class="text-red-400 text-sm mt-1 {{ '' if errors.get('confirmation') else 'hidden' }}">
          {{ errors.get('confirmation','') }}
        </p>
      </div>

      <button
        type="submit"
        class="w-full py-3 text-lg font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
        Register
      </button>
    </form>

    <p class="text-sm text-center text-gray-400">
      Already have an account?
      <a href="{{ url_for('login') }}" class="text-blue-400 hover:text-blue-300 font-medium transition duration-300">Login</a>
    </p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const f = document.getElementById("registerForm");

  const username = document.getElementById("username");
  const email    = document.getElementById("email");
  const password = document.getElementById("password");
  const confirm  = document.getElementById("confirmation");

  const eUser = document.getElementById("usernameError");
  const eMail = document.getElementById("emailError");
  const ePass = document.getElementById("passwordError");
  const eConf = document.getElementById("confirmError");

  const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const pwdRe   = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+\=\[\]\{\};:'",.<>\/?\\|`~]).{8,}$/;

  function setErr(input, node, msg) {
    node.textContent = msg || "";
    if (msg) {
      node.classList.remove("hidden");
      input.classList.remove("border-gray-600", "focus:ring-blue-500");
      input.classList.add("border-red-500", "focus:ring-red-500");
    } else {
      node.classList.add("hidden");
      input.classList.remove("border-red-500", "focus:ring-red-500");
      input.classList.add("border-gray-600", "focus:ring-blue-500");
    }
  }

  function validateUsername() {
    const v = username.value.trim();
    if (!v) { setErr(username, eUser, "Username is required."); return false; }
    setErr(username, eUser, ""); return true;
  }
  function validateEmail() {
    const v = email.value.trim();
    if (!v) { setErr(email, eMail, "Email address is required."); return false; }
    if (!emailRe.test(v)) { setErr(email, eMail, "Please enter a valid email address."); return false; }
    setErr(email, eMail, ""); return true;
  }
  function validatePassword() {
    const v = password.value.trim();
    if (!v) { setErr(password, ePass, "Password is required."); return false; }
    if (!pwdRe.test(v)) { setErr(password, ePass, "Password must be ≥ 8 chars, include one uppercase, one number, and one symbol."); return false; }
    setErr(password, ePass, ""); return true;
  }
  function validateConfirm() {
    const v = confirm.value.trim();
    if (!v) { setErr(confirm, eConf, "Please confirm your password."); return false; }
    if (v !== password.value.trim()) { setErr(confirm, eConf, "Passwords do not match."); return false; }
    setErr(confirm, eConf, ""); return true;
  }

  username.addEventListener("input", validateUsername);
  email.addEventListener("input",    validateEmail);
  password.addEventListener("input", () => { validatePassword(); validateConfirm(); });
  confirm.addEventListener("input",  validateConfirm);

  f.addEventListener("submit", (e) => {
    const ok = validateUsername() & validateEmail() & validatePassword() & validateConfirm();
    if (!ok) e.preventDefault();
  });
});
</script>
{% endblock %}
